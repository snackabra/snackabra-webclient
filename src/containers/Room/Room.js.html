<!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><i><font color="#9A1900">/* Copyright (c) 2021 Magnusson Institute, All Rights Reserved */</font></i>

import React from <font color="#FF0000">'react'</font><font color="#990000">;</font>
import <font color="#FF0000">{</font> GiftedChat<font color="#990000">,</font> Bubble <font color="#FF0000">}</font> from <font color="#FF0000">'react-native-gifted-chat'</font><font color="#990000">;</font>
import <font color="#FF0000">{</font> Route <font color="#FF0000">}</font> from <font color="#FF0000">'react-router-dom'</font><font color="#990000">;</font>
import <font color="#FF0000">{</font> View<font color="#990000">,</font> Text <font color="#FF0000">}</font> from <font color="#FF0000">'react-native'</font><font color="#990000">;</font>
import <font color="#FF0000">{</font> JwModal <font color="#FF0000">}</font> from <font color="#FF0000">'../Modal/Modal'</font><font color="#990000">;</font>
import <font color="#FF0000">'./Room.css'</font><font color="#990000">;</font>
import Admin from <font color="#FF0000">'../../components/Admin/Admin'</font><font color="#990000">;</font>
import attach_img from <font color="#FF0000">'../../static/attach.png'</font><font color="#990000">;</font>
<i><font color="#9A1900">// import lock_icon from '../../static/icons8-lock-64.png';</font></i>
<i><font color="#9A1900">// import secure_lock from '../../static/lock_secure.png';</font></i>
import <font color="#FF0000">{</font> Trans <font color="#FF0000">}</font> from <font color="#FF0000">'@lingui/macro'</font><font color="#990000">;</font>
import <font color="#990000">*</font> as utils from <font color="#FF0000">'../../utils/utils'</font><font color="#990000">;</font>



<i><font color="#9A1900">// these are set in '.env' file at root of project</font></i>
let ROOM_SERVER <font color="#990000">=</font> <font color="#FF0000">"https://"</font> <font color="#990000">+</font> process<font color="#990000">.</font>env<font color="#990000">.</font>REACT_APP_ROOM_SERVER <font color="#990000">+</font> <font color="#FF0000">"/api/room/"</font>
let ROOM_SERVER_WS <font color="#990000">=</font> <font color="#FF0000">"wss://"</font> <font color="#990000">+</font> process<font color="#990000">.</font>env<font color="#990000">.</font>REACT_APP_ROOM_SERVER <font color="#990000">+</font> <font color="#FF0000">"/api/room/"</font>
let STORAGE_SERVER <font color="#990000">=</font> <font color="#FF0000">"https://"</font> <font color="#990000">+</font> process<font color="#990000">.</font>env<font color="#990000">.</font>REACT_APP_STORAGE_SERVER <font color="#990000">+</font> <font color="#FF0000">"/api/v1"</font>

<i><font color="#9A1900">// console.log(process.env)</font></i>

<b><font color="#0000FF">class</font></b> Room <b><font color="#0000FF">extends</font></b> React<font color="#990000">.</font>Component <font color="#FF0000">{</font>

  <b><font color="#000000">constructor</font></b><font color="#990000">(</font>props<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">super</font></b><font color="#990000">(</font>props<font color="#990000">);</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>currentWebSocket <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>roomId<font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state <font color="#990000">=</font> <font color="#FF0000">{</font>
      messages<font color="#990000">:</font> <font color="#990000">[],</font>
      controlMessages<font color="#990000">:</font> <font color="#990000">[],</font>
      loadingMore<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font>
      moreMessages<font color="#990000">:</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font>
      keys<font color="#990000">:</font> <font color="#FF0000">{}</font><font color="#990000">,</font>
      changeUsername<font color="#990000">:</font> <font color="#FF0000">{</font> _id<font color="#990000">:</font> <font color="#FF0000">''</font><font color="#990000">,</font> name<font color="#990000">:</font> <font color="#FF0000">''</font> <font color="#FF0000">}</font><font color="#990000">,</font>
      room_owner<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font>
      locked<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font>
      adminError<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font>
      motd<font color="#990000">:</font> <font color="#FF0000">''</font><font color="#990000">,</font>
      roomCapacity<font color="#990000">:</font> <font color="#993399">2</font><font color="#990000">,</font> <i><font color="#9A1900">// this will get loaded from server (if it's in the server), current system default is 20</font></i>
      joinRequests<font color="#990000">:</font> <font color="#990000">[],</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>

  <i><font color="#9A1900">// ##############################  FUNCTIONS TO GET ALL RELEVANT KEYS FROM KV/DO  ###############################</font></i>

  async <b><font color="#000000">loadPersonalKeys</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      let _exportable_pubKey <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
      let _exportable_privateKey <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
      let _privateKey <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>localStorage<font color="#990000">.</font><b><font color="#000000">getItem</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">)</font> <font color="#990000">==</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">const</font></b> keyPair <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">generateKeys</font></b><font color="#990000">();</font>
        _exportable_pubKey <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">exportKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> keyPair<font color="#990000">.</font>publicKey<font color="#990000">);</font>
        _exportable_privateKey <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">exportKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> keyPair<font color="#990000">.</font>privateKey<font color="#990000">);</font>
        _privateKey <font color="#990000">=</font> keyPair<font color="#990000">.</font>privateKey<font color="#990000">;</font>
        localStorage<font color="#990000">.</font><b><font color="#000000">setItem</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>_exportable_privateKey<font color="#990000">));</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
          _exportable_privateKey <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>localStorage<font color="#990000">.</font><b><font color="#000000">getItem</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">));</font>
          _exportable_pubKey <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">extractPubKey</font></b><font color="#990000">(</font>_exportable_privateKey<font color="#990000">);</font>
          _privateKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> _exportable_privateKey<font color="#990000">,</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"deriveKey"</font><font color="#990000">]);</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#FF0000">{</font>
          <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"The "</font> <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">" key in the localstorage is corrupted. Please try importing it again. If you still find this error, you will need to delete the key for this room from the localStorage and the app will generate a new identity for you."</font> <font color="#FF0000">}</font><font color="#990000">)</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> keys<font color="#990000">:</font> <font color="#FF0000">{</font> exportable_pubKey<font color="#990000">:</font> _exportable_pubKey<font color="#990000">,</font> privateKey<font color="#990000">:</font> _privateKey <font color="#FF0000">}</font> <font color="#FF0000">}</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">)</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">loadRoomKeys</font></b><font color="#990000">(</font>keys<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Loading room keys..."</font><font color="#990000">)</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>keys<font color="#990000">.</font>ownerKey <font color="#990000">===</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Room does not exist"</font> <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
      let _exportable_owner_pubKey <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>keys<font color="#990000">.</font>ownerKey <font color="#990000">||</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{}</font><font color="#990000">));</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>_exportable_owner_pubKey<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">'key'</font><font color="#990000">))</font> <font color="#FF0000">{</font>
        _exportable_owner_pubKey <font color="#990000">=</font> <b><font color="#0000FF">typeof</font></b> _exportable_owner_pubKey<font color="#990000">.</font>key <font color="#990000">===</font> <font color="#FF0000">'object'</font> <font color="#990000">?</font> _exportable_owner_pubKey<font color="#990000">.</font>key <font color="#990000">:</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>_exportable_owner_pubKey<font color="#990000">.</font>key<font color="#990000">)</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        _exportable_owner_pubKey<font color="#990000">.</font>key_ops <font color="#990000">=</font> <font color="#990000">[];</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Error in getKeys(): "</font><font color="#990000">)</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">);</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">const</font></b> _exportable_room_signKey <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>keys<font color="#990000">.</font>signKey<font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> _exportable_encryption_key <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>keys<font color="#990000">.</font>encryptionKey<font color="#990000">);</font>
      let _exportable_verifiedGuest_pubKey <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>keys<font color="#990000">.</font>guestKey  <font color="#990000">||</font> <b><font color="#0000FF">null</font></b><font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> _exportable_pubKey <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> _privateKey <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>privateKey<font color="#990000">;</font>
      let isVerifiedGuest <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> _owner_pubKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> _exportable_owner_pubKey<font color="#990000">,</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[]);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>_owner_pubKey<font color="#990000">.</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>_owner_pubKey<font color="#990000">.</font>error<font color="#990000">);</font>
      <font color="#FF0000">}</font>
      let isOwner <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">areKeysSame</font></b><font color="#990000">(</font>_exportable_pubKey<font color="#990000">,</font> _exportable_owner_pubKey<font color="#990000">);</font>
      let isAdmin <font color="#990000">=</font> <font color="#990000">(</font>document<font color="#990000">.</font>cookie<font color="#990000">.</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">'; '</font><font color="#990000">).</font><b><font color="#000000">find</font></b><font color="#990000">(</font>row <font color="#990000">=&gt;</font> row<font color="#990000">.</font><b><font color="#000000">startsWith</font></b><font color="#990000">(</font><font color="#FF0000">'token_'</font> <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">))</font> <font color="#990000">!==</font> undefined<font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(</font>process<font color="#990000">.</font>env<font color="#990000">.</font>REACT_APP_ROOM_SERVER <font color="#990000">!==</font> <font color="#FF0000">'s_socket.privacy.app'</font> <font color="#990000">&amp;&amp;</font> isOwner<font color="#990000">);</font>
      <i><font color="#9A1900">/* To overwrite owner keys</font></i>
<i><font color="#9A1900">      if (isAdmin &amp;&amp; JSON.stringify(_exportable_owner_pubKey) !== JSON.stringify(_exportable_pubKey)) {</font></i>
<i><font color="#9A1900">        fetch(STORAGE_SERVER + "/postPubKey?roomId=" + this.roomId + "&amp;type=ownerKey", {</font></i>
<i><font color="#9A1900">          method: "POST",</font></i>
<i><font color="#9A1900">          body: JSON.stringify(_exportable_pubKey),</font></i>
<i><font color="#9A1900">          headers: {</font></i>
<i><font color="#9A1900">            "Content-type": "application/json"</font></i>
<i><font color="#9A1900">          },</font></i>
<i><font color="#9A1900">          credentials: 'include'</font></i>
<i><font color="#9A1900">        }).then(() =&gt; fetch(ROOM_SERVER + this.roomId + "/ownerKeyRotation"))</font></i>
<i><font color="#9A1900">        _exportable_owner_pubKey = _exportable_pubKey;</font></i>
<i><font color="#9A1900">      }</font></i>
<i><font color="#9A1900">      */</font></i>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>isOwner <font color="#990000">&amp;&amp;</font> <font color="#990000">!</font>isAdmin<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>_exportable_verifiedGuest_pubKey <font color="#990000">===</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
          <b><font color="#000000">fetch</font></b><font color="#990000">(</font>ROOM_SERVER <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/postPubKey?type=guestKey"</font><font color="#990000">,</font> <font color="#FF0000">{</font>
            method<font color="#990000">:</font> <font color="#FF0000">"POST"</font><font color="#990000">,</font>
            body<font color="#990000">:</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>_exportable_pubKey<font color="#990000">),</font>
            headers<font color="#990000">:</font> <font color="#FF0000">{</font>
              <font color="#FF0000">"Content-Type"</font><font color="#990000">:</font> <font color="#FF0000">"application/json"</font>
            <font color="#FF0000">}</font>
          <font color="#FF0000">}</font><font color="#990000">);</font>
          _exportable_verifiedGuest_pubKey <font color="#990000">=</font> <font color="#FF0000">{</font> <font color="#990000">...</font>_exportable_pubKey <font color="#FF0000">}</font><font color="#990000">;</font>
        <font color="#FF0000">}</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">areKeysSame</font></b><font color="#990000">(</font>_exportable_verifiedGuest_pubKey<font color="#990000">,</font> _exportable_pubKey<font color="#990000">))</font> <font color="#FF0000">{</font>
          isVerifiedGuest <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>

      <b><font color="#0000FF">const</font></b> _encryption_key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> _exportable_encryption_key<font color="#990000">,</font> <font color="#FF0000">"AES"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">,</font> <font color="#FF0000">"decrypt"</font><font color="#990000">]);</font>

      <b><font color="#0000FF">const</font></b> _room_privateSignKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> _exportable_room_signKey<font color="#990000">,</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">'deriveKey'</font><font color="#990000">]);</font>
      <b><font color="#0000FF">const</font></b> _exportable_room_signPubKey <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">extractPubKey</font></b><font color="#990000">(</font>_exportable_room_signKey<font color="#990000">);</font>

      <b><font color="#0000FF">const</font></b> _room_signPubKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> _exportable_room_signPubKey<font color="#990000">,</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[]);</font>
      <b><font color="#0000FF">const</font></b> _personal_signKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font>_privateKey<font color="#990000">,</font> _room_signPubKey<font color="#990000">,</font> <font color="#FF0000">"HMAC"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"sign"</font><font color="#990000">,</font> <font color="#FF0000">"verify"</font><font color="#990000">])</font>

      let _shared_key <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>isOwner<font color="#990000">)</font> <font color="#FF0000">{</font>
        _shared_key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font>_privateKey<font color="#990000">,</font> _owner_pubKey<font color="#990000">,</font> <font color="#FF0000">"AES"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">,</font> <font color="#FF0000">"decrypt"</font><font color="#990000">]);</font>
      <font color="#FF0000">}</font>

      let _locked_key <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
      let _exportable_locked_key <font color="#990000">=</font> localStorage<font color="#990000">.</font><b><font color="#000000">getItem</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">'_lockedKey'</font><font color="#990000">);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>_exportable_locked_key <font color="#990000">!==</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
        _locked_key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>_exportable_locked_key<font color="#990000">),</font> <font color="#FF0000">"AES"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">,</font> <font color="#FF0000">"decrypt"</font><font color="#990000">]);</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>keys<font color="#990000">.</font>locked_key<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">const</font></b> _string_locked_key <font color="#990000">=</font> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">decrypt</font></b><font color="#990000">(</font>isOwner <font color="#990000">?</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>privateKey<font color="#990000">,</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">,</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[]),</font> <font color="#FF0000">"AES"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"decrypt"</font><font color="#990000">])</font> <font color="#990000">:</font> _shared_key<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>keys<font color="#990000">.</font>locked_key<font color="#990000">),</font> <font color="#FF0000">"string"</font><font color="#990000">)).</font>plaintext<font color="#990000">;</font>
        _exportable_locked_key <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>_string_locked_key<font color="#990000">);</font>
        _locked_key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>_exportable_locked_key<font color="#990000">),</font> <font color="#FF0000">"AES"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">,</font> <font color="#FF0000">"decrypt"</font><font color="#990000">]);</font>
      <font color="#FF0000">}</font>

      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> keys<font color="#990000">:</font> <font color="#FF0000">{</font> <font color="#990000">...</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">,</font> shared_key<font color="#990000">:</font> _shared_key<font color="#990000">,</font> exportable_owner_pubKey<font color="#990000">:</font> _exportable_owner_pubKey<font color="#990000">,</font> exportable_verifiedGuest_pubKey<font color="#990000">:</font> _exportable_verifiedGuest_pubKey<font color="#990000">,</font> personal_signKey<font color="#990000">:</font> _personal_signKey<font color="#990000">,</font> room_privateSignKey<font color="#990000">:</font> _room_privateSignKey<font color="#990000">,</font> encryptionKey<font color="#990000">:</font> _encryption_key<font color="#990000">,</font> locked_key<font color="#990000">:</font> _locked_key<font color="#990000">,</font> exportable_locked_key<font color="#990000">:</font> _exportable_locked_key <font color="#FF0000">}</font><font color="#990000">,</font> room_owner<font color="#990000">:</font> isOwner<font color="#990000">,</font> room_admin<font color="#990000">:</font> isAdmin<font color="#990000">,</font> verifiedGuest<font color="#990000">:</font> isVerifiedGuest <font color="#FF0000">}</font><font color="#990000">)</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>currentWebSocket<font color="#990000">.</font><b><font color="#000000">send</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> ready<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">));</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">'Room keys loaded!'</font><font color="#990000">);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isAdmin<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getAdminData</font></b><font color="#990000">();</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font><b><font color="#000000">showAdminTab</font></b><font color="#990000">();</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Failure loading room keys. Please try joining the room again...'</font> <font color="#FF0000">}</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <i><font color="#9A1900">// ############################   FUNCTIONS TO HANDLE WEBSOCKET   ##########################################</font></i>


  <b><font color="#000000">join</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      let ws <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">WebSocket</font></b><font color="#990000">(</font>ROOM_SERVER_WS <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/websocket"</font><font color="#990000">);</font>
      let rejoined <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
      let startTime <font color="#990000">=</font> Date<font color="#990000">.</font><b><font color="#000000">now</font></b><font color="#990000">();</font>

      let rejoin <font color="#990000">=</font> <b><font color="#000000">async</font></b> <font color="#990000">()</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>rejoined<font color="#990000">)</font> <font color="#FF0000">{</font>
          rejoined <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
          <b><font color="#0000FF">this</font></b><font color="#990000">.</font>currentWebSocket <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>

          <i><font color="#9A1900">// Don't try to reconnect too rapidly.</font></i>
          let timeSinceLastJoin <font color="#990000">=</font> Date<font color="#990000">.</font><b><font color="#000000">now</font></b><font color="#990000">()</font> <font color="#990000">-</font> startTime<font color="#990000">;</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>timeSinceLastJoin <font color="#990000">&lt;</font> <font color="#993399">10000</font><font color="#990000">)</font> <font color="#FF0000">{</font>
            <i><font color="#9A1900">// Less than 10 seconds elapsed since last join. Pause a bit.</font></i>
            await <b><font color="#0000FF">new</font></b> <b><font color="#000000">Promise</font></b><font color="#990000">(</font>resolve <font color="#990000">=&gt;</font> <b><font color="#000000">setTimeout</font></b><font color="#990000">(</font>resolve<font color="#990000">,</font> <font color="#993399">10000</font> <font color="#990000">-</font> timeSinceLastJoin<font color="#990000">));</font>
          <font color="#FF0000">}</font>

          <i><font color="#9A1900">// OK, reconnect now!</font></i>
          <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">join</font></b><font color="#990000">();</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>

      ws<font color="#990000">.</font><b><font color="#000000">addEventListener</font></b><font color="#990000">(</font><font color="#FF0000">"open"</font><font color="#990000">,</font> event <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>currentWebSocket <font color="#990000">=</font> ws<font color="#990000">;</font>

        <i><font color="#9A1900">// Send user info message.</font></i>
        ws<font color="#990000">.</font><b><font color="#000000">send</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> name<font color="#990000">:</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">)</font> <font color="#FF0000">}</font><font color="#990000">));</font>
      <font color="#FF0000">}</font><font color="#990000">);</font>

      ws<font color="#990000">.</font><b><font color="#000000">addEventListener</font></b><font color="#990000">(</font><font color="#FF0000">"message"</font><font color="#990000">,</font> async event <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
        let data <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>event<font color="#990000">.</font>data<font color="#990000">);</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>data<font color="#990000">.</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemInfo</font></b><font color="#990000">(</font><font color="#FF0000">"Error from server: "</font> <font color="#990000">+</font> data<font color="#990000">.</font>error<font color="#990000">)</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>data<font color="#990000">.</font>ready<font color="#990000">)</font> <font color="#FF0000">{</font>
          let _keys <font color="#990000">=</font> data<font color="#990000">.</font>keys<font color="#990000">;</font>
          await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">loadRoomKeys</font></b><font color="#990000">(</font>_keys<font color="#990000">);</font>
          <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> motd<font color="#990000">:</font> data<font color="#990000">.</font>motd<font color="#990000">,</font> ownerRotation<font color="#990000">:</font> data<font color="#990000">.</font>ownerRotation<font color="#990000">,</font> locked<font color="#990000">:</font> data<font color="#990000">.</font>roomLocked <font color="#FF0000">}</font><font color="#990000">);</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>data<font color="#990000">.</font>motd <font color="#990000">!==</font> <font color="#FF0000">''</font><font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemInfo</font></b><font color="#990000">(</font><font color="#FF0000">'Message of the Day: '</font> <font color="#990000">+</font> data<font color="#990000">.</font>motd<font color="#990000">);</font>
          <font color="#FF0000">}</font>
          <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
            <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemMessage</font></b><font color="#990000">(</font><font color="#FF0000">'Connected'</font><font color="#990000">);</font>
          <font color="#FF0000">}</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>data<font color="#990000">.</font>system<font color="#990000">)</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>data<font color="#990000">.</font>keyRotation<font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemInfo</font></b><font color="#990000">(</font><font color="#FF0000">'The room owner has rotated their keys. Please reload the room to update your copy of the owner keys.'</font><font color="#990000">)</font>
          <font color="#FF0000">}</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
          <b><font color="#0000FF">const</font></b> messages <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">unwrapMessages</font></b><font color="#990000">(</font>data<font color="#990000">);</font>
          await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">addChatMessage</font></b><font color="#990000">(</font>messages<font color="#990000">)</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font><font color="#990000">);</font>

      ws<font color="#990000">.</font><b><font color="#000000">addEventListener</font></b><font color="#990000">(</font><font color="#FF0000">"close"</font><font color="#990000">,</font> event <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>event<font color="#990000">.</font>code <font color="#990000">===</font> <font color="#993399">4000</font><font color="#990000">)</font> <font color="#FF0000">{</font>
          <i><font color="#9A1900">// console.log('Room does not exist');</font></i>
          <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> event<font color="#990000">.</font>reason <font color="#FF0000">}</font><font color="#990000">)</font>
        <font color="#FF0000">}</font>
        <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
          console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"WebSocket closed, reconnecting:"</font><font color="#990000">,</font> event<font color="#990000">.</font>code<font color="#990000">,</font> event<font color="#990000">.</font>reason<font color="#990000">);</font>
          <b><font color="#000000">rejoin</font></b><font color="#990000">();</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font><font color="#990000">);</font>
      ws<font color="#990000">.</font><b><font color="#000000">addEventListener</font></b><font color="#990000">(</font><font color="#FF0000">"error"</font><font color="#990000">,</font> event <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"WebSocket error, reconnecting:"</font><font color="#990000">,</font> event<font color="#990000">);</font>
        <b><font color="#000000">rejoin</font></b><font color="#990000">();</font>
      <font color="#FF0000">}</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemInfo</font></b><font color="#990000">(</font><font color="#FF0000">'Could not connect to websocket'</font><font color="#990000">)</font>
      <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Could not connect to the websocket'</font> <font color="#FF0000">}</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <i><font color="#9A1900">// ############################   FUNCTIONS TO HANDLE MESSAGES  ############################################</font></i>


  <b><font color="#000000">sendSystemInfo</font></b><font color="#990000">(</font>msg_string<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> messages<font color="#990000">:</font> <font color="#990000">[...</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#990000">,</font> <font color="#FF0000">{</font> _id<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#990000">.</font>length<font color="#990000">,</font> text<font color="#990000">:</font> msg_string<font color="#990000">,</font> user<font color="#990000">:</font> <font color="#FF0000">{</font> _id<font color="#990000">:</font> <font color="#FF0000">'system'</font><font color="#990000">,</font> name<font color="#990000">:</font> <font color="#FF0000">'System Message'</font> <font color="#FF0000">}</font><font color="#990000">,</font> whispered<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> verified<font color="#990000">:</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> info<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">]</font> <font color="#FF0000">}</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">sendSystemMessage</font></b><font color="#990000">(</font>message<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> messages<font color="#990000">:</font> <font color="#990000">[...</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#990000">,</font> <font color="#FF0000">{</font> _id<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#990000">.</font>length<font color="#990000">,</font> text<font color="#990000">:</font> message<font color="#990000">,</font> system<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">]</font> <font color="#FF0000">}</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">unwrapMessages</font></b><font color="#990000">(</font>new_messages<font color="#990000">)</font> <font color="#FF0000">{</font>
    let unwrapped_messages <font color="#990000">=</font> <font color="#FF0000">{}</font>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let id <b><font color="#0000FF">in</font></b> new_messages<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>new_messages<font color="#990000">[</font>id<font color="#990000">].</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">"encrypted_contents"</font><font color="#990000">))</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
          <b><font color="#0000FF">const</font></b> decryption_key <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>encryptionKey
          let msg <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">decrypt</font></b><font color="#990000">(</font>decryption_key<font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>encrypted_contents<font color="#990000">)</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>msg<font color="#990000">.</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
            msg <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">decrypt</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>locked_key<font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>encrypted_contents<font color="#990000">)</font>
          <font color="#FF0000">}</font>
          <i><font color="#9A1900">// console.log(msg)</font></i>
          <b><font color="#0000FF">const</font></b> _json_msg <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>msg<font color="#990000">.</font>plaintext<font color="#990000">);</font>
          <i><font color="#9A1900">// console.log(_json_msg)</font></i>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>_json_msg<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">'control'</font><font color="#990000">))</font> <font color="#FF0000">{</font>
            unwrapped_messages<font color="#990000">[</font>id<font color="#990000">]</font> <font color="#990000">=</font> _json_msg<font color="#990000">;</font>
          <font color="#FF0000">}</font>
          <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
            <i><font color="#9A1900">// console.log(_json_msg);</font></i>
            <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> controlMessages<font color="#990000">:</font> <font color="#990000">[...</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>controlMessages<font color="#990000">,</font> _json_msg<font color="#990000">]</font> <font color="#FF0000">}</font><font color="#990000">)</font>
          <font color="#FF0000">}</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
          <i><font color="#9A1900">// console.log(e);</font></i>
          <i><font color="#9A1900">// Skip the message if decryption fails - its probably due to the user not having &lt;roomId&gt;_lockedKey. </font></i>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        unwrapped_messages<font color="#990000">[</font>id<font color="#990000">]</font> <font color="#990000">=</font> new_messages<font color="#990000">[</font>id<font color="#990000">];</font>
      <font color="#FF0000">}</font>
      localStorage<font color="#990000">.</font><b><font color="#000000">setItem</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"_lastSeenMessage"</font><font color="#990000">,</font> id<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">.</font>length<font color="#990000">));</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> unwrapped_messages<font color="#990000">;</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">wrapMessage</font></b><font color="#990000">(</font>contents<font color="#990000">)</font> <font color="#FF0000">{</font>
    let enc_key<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>locked <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>locked_key <font color="#990000">!=</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
      enc_key <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>locked_key<font color="#990000">;</font>
      <i><font color="#9A1900">// console.log(enc_key)</font></i>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>contents<font color="#990000">.</font>encrypted <font color="#990000">||</font> <font color="#990000">!</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>locked<font color="#990000">)</font> <font color="#FF0000">{</font>
      enc_key <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>encryptionKey<font color="#990000">;</font>
    <font color="#FF0000">}</font>
    let msg<font color="#990000">;</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// console.log(enc_key)</font></i>
      msg <font color="#990000">=</font> <font color="#FF0000">{</font> encrypted_contents<font color="#990000">:</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">encrypt</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>contents<font color="#990000">),</font> enc_key<font color="#990000">,</font> <font color="#FF0000">"string"</font><font color="#990000">)</font> <font color="#FF0000">}</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Could not send message. The encryption key seems to be corrupted.'</font> <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> msg<font color="#990000">;</font>

  <font color="#FF0000">}</font>


  async <b><font color="#000000">addChatMessage</font></b><font color="#990000">(</font>new_messages<font color="#990000">,</font> old_messages <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
    let messages <font color="#990000">=</font> <font color="#990000">[];</font>
    let _text_verified <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
    let _image_verified <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
    let _imageMetadata_verified <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
    let contacts <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>contacts<font color="#990000">;</font>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let id <b><font color="#0000FF">in</font></b> new_messages<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>new_messages<font color="#990000">[</font>id<font color="#990000">].</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">'contents'</font><font color="#990000">))</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>new_messages<font color="#990000">[</font>id<font color="#990000">].</font>encrypted <font color="#990000">===</font> <b><font color="#0000FF">true</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
            let shared_key <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>shared_key
            <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">areKeysSame</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>sender_pubKey<font color="#990000">))</font> <font color="#FF0000">{</font>
              shared_key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>privateKey<font color="#990000">,</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>sender_pubKey<font color="#990000">,</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[]),</font> <font color="#FF0000">"AES"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">,</font> <font color="#FF0000">"decrypt"</font><font color="#990000">]);</font>
            <font color="#FF0000">}</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>new_messages<font color="#990000">[</font>id<font color="#990000">].</font>recipient <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>room_owner<font color="#990000">)</font> <font color="#FF0000">{</font>
              shared_key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>privateKey<font color="#990000">,</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>recipient<font color="#990000">,</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[]),</font> <font color="#FF0000">"AES"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">,</font> <font color="#FF0000">"decrypt"</font><font color="#990000">]);</font>
            <font color="#FF0000">}</font>
            let decrypted_message <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">decrypt</font></b><font color="#990000">(</font>shared_key<font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>contents<font color="#990000">)</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>decrypted_message<font color="#990000">.</font>error <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>room_owner<font color="#990000">)</font> <font color="#FF0000">{</font>
              shared_key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>room_privateKey<font color="#990000">,</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>sender_pubKey<font color="#990000">,</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[]),</font> <font color="#FF0000">"AES"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">,</font> <font color="#FF0000">"decrypt"</font><font color="#990000">]);</font>
              decrypted_message <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">decrypt</font></b><font color="#990000">(</font>shared_key<font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>contents<font color="#990000">)</font>
            <font color="#FF0000">}</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>new_messages<font color="#990000">[</font>id<font color="#990000">].</font>image <font color="#990000">!=</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
              <b><font color="#0000FF">const</font></b> decrypted_image <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">decrypt</font></b><font color="#990000">(</font>shared_key<font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>image<font color="#990000">,</font> <font color="#FF0000">"arrayBuffer"</font><font color="#990000">);</font>
              new_messages<font color="#990000">[</font>id<font color="#990000">].</font>image <font color="#990000">=</font> decrypted_image<font color="#990000">.</font>error <font color="#990000">?</font> <font color="#FF0000">''</font> <font color="#990000">:</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getFileData</font></b><font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">File</font></b><font color="#990000">([</font>decrypted_image<font color="#990000">.</font>plaintext<font color="#990000">],</font> <font color="#FF0000">"img"</font><font color="#990000">,</font> <font color="#FF0000">{</font> type<font color="#990000">:</font> <font color="#FF0000">"image/jpeg"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#FF0000">"url"</font><font color="#990000">)</font>
              <b><font color="#0000FF">const</font></b> decrypted_imageMetadata <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">decrypt</font></b><font color="#990000">(</font>shared_key<font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>imageMetaData<font color="#990000">)</font>
              new_messages<font color="#990000">[</font>id<font color="#990000">].</font>imageMetaData <font color="#990000">=</font> decrypted_imageMetadata<font color="#990000">.</font>error <font color="#990000">?</font> <font color="#FF0000">{}</font> <font color="#990000">:</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>decrypted_imageMetadata<font color="#990000">.</font>plaintext<font color="#990000">);</font>
            <font color="#FF0000">}</font>
            new_messages<font color="#990000">[</font>id<font color="#990000">].</font>contents <font color="#990000">=</font> decrypted_message<font color="#990000">.</font>plaintext
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>decrypted_message<font color="#990000">.</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
              new_messages<font color="#990000">[</font>id<font color="#990000">].</font>whispered <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
            <font color="#FF0000">}</font>
          <font color="#FF0000">}</font>
          <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
            <b><font color="#0000FF">const</font></b> sign <font color="#990000">=</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>sign<font color="#990000">;</font>
            <b><font color="#0000FF">const</font></b> _image_sign <font color="#990000">=</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>image_sign
            <b><font color="#0000FF">const</font></b> _imageMetadata_sign <font color="#990000">=</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>imageMetadata_sign<font color="#990000">;</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>sign <font color="#990000">||</font> <font color="#990000">!</font>_image_sign <font color="#990000">||</font> <font color="#990000">!</font>_imageMetadata_sign<font color="#990000">)</font> <font color="#FF0000">{</font>
              _text_verified <font color="#990000">=</font> <b><font color="#0000FF">false</font></b>
            <font color="#FF0000">}</font>
            <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
              <b><font color="#0000FF">const</font></b> sender_pubKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>sender_pubKey<font color="#990000">,</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[]);</font>
              <b><font color="#0000FF">const</font></b> verificationKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>room_privateSignKey<font color="#990000">,</font> sender_pubKey<font color="#990000">,</font> <font color="#FF0000">"HMAC"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"sign"</font><font color="#990000">,</font> <font color="#FF0000">"verify"</font><font color="#990000">])</font>
              _text_verified <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verify</font></b><font color="#990000">(</font>verificationKey<font color="#990000">,</font> sign<font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>contents<font color="#990000">)</font>
              _image_verified <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verify</font></b><font color="#990000">(</font>verificationKey<font color="#990000">,</font> _image_sign<font color="#990000">,</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>image<font color="#990000">)</font>
              _imageMetadata_verified <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">verify</font></b><font color="#990000">(</font>verificationKey<font color="#990000">,</font> _imageMetadata_sign<font color="#990000">,</font> <b><font color="#0000FF">typeof</font></b> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>imageMetaData <font color="#990000">===</font> <font color="#FF0000">"object"</font> <font color="#990000">?</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>new_messages<font color="#990000">[</font>id<font color="#990000">].</font>imageMetaData<font color="#990000">)</font> <font color="#990000">:</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>imageMetaData<font color="#990000">)</font>
            <font color="#FF0000">}</font>
          <font color="#FF0000">}</font>
          let user_key <font color="#990000">=</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>sender_pubKey<font color="#990000">.</font>x <font color="#990000">+</font> <font color="#FF0000">" "</font> <font color="#990000">+</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>sender_pubKey<font color="#990000">.</font>y<font color="#990000">;</font>
          let username <font color="#990000">=</font> <font color="#FF0000">""</font><font color="#990000">;</font>
          let user_id <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>new_messages<font color="#990000">[</font>id<font color="#990000">].</font>sender_pubKey<font color="#990000">);</font>
          <b><font color="#0000FF">const</font></b> unnamed <font color="#990000">=</font> <font color="#990000">[</font><font color="#FF0000">'Anonymous'</font><font color="#990000">,</font> <font color="#FF0000">'No Name'</font><font color="#990000">,</font> <font color="#FF0000">'Nameless'</font><font color="#990000">,</font> <font color="#FF0000">'Incognito'</font><font color="#990000">,</font> <font color="#FF0000">'Voldemort'</font><font color="#990000">,</font> <font color="#FF0000">'Uomo Senza Nome'</font><font color="#990000">,</font> <font color="#FF0000">'The Kid'</font><font color="#990000">,</font> <font color="#FF0000">'Gunslinger'</font><font color="#990000">,</font> <font color="#FF0000">'IT '</font><font color="#990000">,</font> <font color="#FF0000">'Person in Black'</font><font color="#990000">,</font> <font color="#FF0000">''</font><font color="#990000">,</font> <font color="#FF0000">''</font><font color="#990000">,</font> <font color="#FF0000">''</font><font color="#990000">];</font>
          <b><font color="#0000FF">const</font></b> local_username <font color="#990000">=</font> contacts<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font>user_key<font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> contacts<font color="#990000">[</font>user_key<font color="#990000">].</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">' '</font><font color="#990000">)[</font><font color="#993399">0</font><font color="#990000">]</font> <font color="#990000">!==</font> <font color="#FF0000">'User'</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">!</font>unnamed<font color="#990000">.</font><b><font color="#000000">includes</font></b><font color="#990000">(</font>contacts<font color="#990000">[</font>user_key<font color="#990000">].</font><b><font color="#000000">trim</font></b><font color="#990000">())</font> <font color="#990000">?</font> contacts<font color="#990000">[</font>user_key<font color="#990000">]</font> <font color="#990000">:</font> <font color="#FF0000">'Unnamed'</font><font color="#990000">;</font>
          contacts<font color="#990000">[</font>user_key<font color="#990000">]</font> <font color="#990000">=</font> local_username<font color="#990000">;</font>
          <b><font color="#0000FF">const</font></b> alias <font color="#990000">=</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">'sender_username'</font><font color="#990000">)</font> <font color="#990000">?</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>sender_username <font color="#990000">:</font> <font color="#FF0000">''</font><font color="#990000">;</font>
          <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>user_key <font color="#990000">===</font> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">.</font>x <font color="#990000">+</font> <font color="#FF0000">" "</font> <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">.</font>y<font color="#990000">)</font> <font color="#990000">||</font> local_username <font color="#990000">===</font> <font color="#FF0000">'Me'</font><font color="#990000">)</font> <font color="#FF0000">{</font>
            contacts<font color="#990000">[</font>user_key<font color="#990000">]</font> <font color="#990000">=</font> <font color="#FF0000">'Me'</font><font color="#990000">;</font>
            username <font color="#990000">=</font> <font color="#FF0000">'Me'</font><font color="#990000">;</font>
            user_id <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">);</font>
          <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>alias <font color="#990000">!==</font> <font color="#FF0000">''</font><font color="#990000">)</font> <font color="#FF0000">{</font>
              username <font color="#990000">=</font> <font color="#990000">(</font>local_username <font color="#990000">===</font> alias <font color="#990000">||</font> local_username <font color="#990000">===</font> <font color="#FF0000">'Unnamed'</font><font color="#990000">)</font> <font color="#990000">?</font> alias <font color="#990000">:</font> alias <font color="#990000">+</font> <font color="#FF0000">'  ('</font> <font color="#990000">+</font> local_username <font color="#990000">+</font> <font color="#FF0000">')'</font><font color="#990000">;</font>
            <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
              username <font color="#990000">=</font> <font color="#FF0000">'('</font> <font color="#990000">+</font> local_username <font color="#990000">+</font> <font color="#FF0000">')'</font><font color="#990000">;</font>
            <font color="#FF0000">}</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">areKeysSame</font></b><font color="#990000">(</font>new_messages<font color="#990000">[</font>id<font color="#990000">].</font>sender_pubKey<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_verifiedGuest_pubKey<font color="#990000">))</font> <font color="#FF0000">{</font>
              username <font color="#990000">+=</font> <font color="#FF0000">"  (Verified)"</font>
            <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">areKeysSame</font></b><font color="#990000">(</font>new_messages<font color="#990000">[</font>id<font color="#990000">].</font>sender_pubKey<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_owner_pubKey<font color="#990000">))</font> <font color="#FF0000">{</font>
              username <font color="#990000">+=</font> <font color="#FF0000">"  (Owner)"</font>
            <font color="#FF0000">}</font>
          <font color="#FF0000">}</font>
          let new_message <font color="#990000">=</font> <font color="#FF0000">{</font> _id<font color="#990000">:</font> id<font color="#990000">,</font> text<font color="#990000">:</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>contents<font color="#990000">,</font> user<font color="#990000">:</font> <font color="#FF0000">{</font> _id<font color="#990000">:</font> user_id<font color="#990000">,</font> name<font color="#990000">:</font> username <font color="#FF0000">}</font><font color="#990000">,</font> whispered<font color="#990000">:</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>encrypted<font color="#990000">,</font> createdAt<font color="#990000">:</font> <b><font color="#000000">parseInt</font></b><font color="#990000">(</font>id<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(-</font><font color="#993399">42</font><font color="#990000">),</font> <font color="#993399">2</font><font color="#990000">),</font> verified<font color="#990000">:</font> _text_verified <font color="#990000">&amp;&amp;</font> _image_verified <font color="#990000">&amp;&amp;</font> _imageMetadata_verified<font color="#990000">,</font> image<font color="#990000">:</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>image<font color="#990000">,</font> imageMetaData<font color="#990000">:</font> <b><font color="#0000FF">typeof</font></b> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>imageMetaData <font color="#990000">===</font> <font color="#FF0000">"object"</font> <font color="#990000">?</font> new_messages<font color="#990000">[</font>id<font color="#990000">].</font>imageMetaData <font color="#990000">:</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>new_messages<font color="#990000">[</font>id<font color="#990000">].</font>imageMetaData<font color="#990000">)</font> <font color="#FF0000">}</font><font color="#990000">;</font>

          <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#990000">.</font><b><font color="#000000">some</font></b><font color="#990000">((</font>message<font color="#990000">)</font> <font color="#990000">=&gt;</font> new_message<font color="#990000">.</font>_id <font color="#990000">===</font> message<font color="#990000">.</font>_id <font color="#990000">&amp;&amp;</font> new_message<font color="#990000">.</font>id <font color="#990000">!==</font> <font color="#FF0000">'system'</font><font color="#990000">))</font> <font color="#FF0000">{</font>
            messages<font color="#990000">.</font><b><font color="#000000">push</font></b><font color="#990000">(</font>new_message<font color="#990000">);</font>
          <font color="#FF0000">}</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <font color="#FF0000">}</font>

    <font color="#FF0000">}</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font><b><font color="#000000">updateContacts</font></b><font color="#990000">(</font>contacts<font color="#990000">);</font>

    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>old_messages<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> moreMessages <font color="#990000">=</font> messages<font color="#990000">.</font>length <font color="#990000">!==</font> <font color="#993399">0</font><font color="#990000">;</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>moreMessages<font color="#990000">)</font> <font color="#FF0000">{</font>
        messages<font color="#990000">.</font><b><font color="#000000">push</font></b><font color="#990000">(</font><font color="#FF0000">{</font> _id<font color="#990000">:</font> <font color="#FF0000">"no_old_message"</font><font color="#990000">,</font> text<font color="#990000">:</font> <font color="#FF0000">"No older messages"</font><font color="#990000">,</font> system<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">)</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> messages<font color="#990000">:</font> <font color="#990000">[...</font>messages<font color="#990000">,</font> <font color="#990000">...</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#990000">],</font> moreMessages<font color="#990000">:</font> moreMessages <font color="#FF0000">}</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> messages<font color="#990000">:</font> <font color="#990000">[...</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#990000">,</font> <font color="#990000">...</font>messages<font color="#990000">]</font> <font color="#FF0000">}</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">getOldMessages</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> loadingMore<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">)</font>
      <b><font color="#0000FF">const</font></b> currentMessagesLength <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#990000">.</font>length<font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> fetch_resp <font color="#990000">=</font> await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>ROOM_SERVER <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/oldMessages?currentMessagesLength="</font> <font color="#990000">+</font> currentMessagesLength<font color="#990000">)</font>
      let old_messages <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">unwrapMessages</font></b><font color="#990000">(</font>await fetch_resp<font color="#990000">.</font><b><font color="#000000">json</font></b><font color="#990000">());</font>
      <i><font color="#9A1900">// console.log(old_messages)</font></i>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">addChatMessage</font></b><font color="#990000">(</font>old_messages<font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">);</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> loadingMore<font color="#990000">:</font> <b><font color="#0000FF">false</font></b> <font color="#FF0000">}</font><font color="#990000">)</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">)</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemInfo</font></b><font color="#990000">(</font><font color="#FF0000">'Could not fetch older messages'</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">sendMessage</font></b><font color="#990000">(</font>message<font color="#990000">,</font> whisper <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>

    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// If room has not been initalized, set system message</font></i>

      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><font color="#FF0000">"error"</font> <b><font color="#0000FF">in</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemInfo</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>error<font color="#990000">)</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> moreMessages<font color="#990000">:</font> <b><font color="#0000FF">false</font></b> <font color="#FF0000">}</font><font color="#990000">)</font>
        <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>

      <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>whisper <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>locked_key <font color="#990000">==</font> <b><font color="#0000FF">null</font></b> <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>locked<font color="#990000">)</font> <font color="#FF0000">{</font>

        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemInfo</font></b><font color="#990000">(</font><font color="#FF0000">'This room is restricted. A request to the Owner has already been sent. Until you are accepted you cannot chat in the room. You can still whisper the owner by pressing the user icon in the top right corner.'</font><font color="#990000">)</font>
        <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>
      let encrypted <font color="#990000">=</font> <font color="#990000">(</font>whisper <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>shared_key <font color="#990000">!=</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>reply_to<font color="#990000">;</font>

      let contents <font color="#990000">=</font> <font color="#FF0000">{}</font>
      let msg <font color="#990000">=</font> <font color="#FF0000">{}</font>
      let shared_key <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>shared_key<font color="#990000">;</font>
      let file_inp <font color="#990000">=</font> document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'fileInput'</font><font color="#990000">);</font>
      let file <font color="#990000">=</font> file_inp<font color="#990000">.</font>files<font color="#990000">.</font>length <font color="#990000">&gt;</font> <font color="#993399">0</font> <font color="#990000">?</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getFileData</font></b><font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">restrictPhoto</font></b><font color="#990000">(</font>file_inp<font color="#990000">.</font>files<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font> <font color="#993399">15</font><font color="#990000">,</font> <font color="#FF0000">"image/jpeg"</font><font color="#990000">,</font> <font color="#993399">0.92</font><font color="#990000">),</font> encrypted <font color="#990000">?</font> <font color="#FF0000">'arrayBuffer'</font> <font color="#990000">:</font> <font color="#FF0000">'url'</font><font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
      <i><font color="#9A1900">// let imgId, imgKey, previewId, previewKey = '';</font></i>
      let imgId <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">,</font> previewId <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">,</font> imgKey <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">,</font> previewKey <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">,</font> fullStorePromise <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">,</font> previewStorePromise <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">;</font>
      <i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900">      if (file != null) {</font></i>
<i><font color="#9A1900">        let image_data = await this.saveImage(file_inp.files[0]);</font></i>
<i><font color="#9A1900">        let imgKeys = image_data.full;</font></i>
<i><font color="#9A1900">        imgId = imgKeys.id;</font></i>
<i><font color="#9A1900">        imgKey = imgKeys.key;</font></i>
<i><font color="#9A1900">        let previewKeys = image_data.preview;</font></i>
<i><font color="#9A1900">        previewId = previewKeys.id;</font></i>
<i><font color="#9A1900">        previewKey = previewKeys.key;</font></i>
<i><font color="#9A1900">      }</font></i>
<i><font color="#9A1900">      */</font></i>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>file <font color="#990000">!=</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
        let image_data <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">saveImage</font></b><font color="#990000">(</font>file_inp<font color="#990000">.</font>files<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]);</font>
        imgId <font color="#990000">=</font> image_data<font color="#990000">.</font>full<font color="#990000">;</font>
        imgKey <font color="#990000">=</font> image_data<font color="#990000">.</font>fullKey<font color="#990000">;</font>
        previewId <font color="#990000">=</font> image_data<font color="#990000">.</font>preview<font color="#990000">;</font>
        previewKey <font color="#990000">=</font> image_data<font color="#990000">.</font>previewKey<font color="#990000">;</font>
        fullStorePromise <font color="#990000">=</font> image_data<font color="#990000">.</font>fullStorePromise<font color="#990000">;</font>
        previewStorePromise <font color="#990000">=</font> image_data<font color="#990000">.</font>previewStorePromise<font color="#990000">;</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>message<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">].</font>text <font color="#990000">===</font> <font color="#FF0000">''</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>

      <i><font color="#9A1900">// If room owner wants to reply with an encrypted message to a particular user (or message sender), use a shared AES key between the user and that message sender</font></i>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>reply_to<font color="#990000">)</font> <font color="#FF0000">{</font>
        shared_key <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>reply_encryptionKey<font color="#990000">;</font>
        contents<font color="#990000">.</font>recipient <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>reply_to<font color="#990000">.</font>_id<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      <i><font color="#9A1900">// Encrypt message with shared key between room owner and verified guest if the "Whisper" checkbox is selected or if the room owner wants to reply to a particular message with an encrypted message</font></i>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>encrypted<font color="#990000">)</font> <font color="#FF0000">{</font>

        <b><font color="#0000FF">const</font></b> _content <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">encrypt</font></b><font color="#990000">(</font>message<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">].</font>text<font color="#990000">,</font> shared_key<font color="#990000">,</font> <font color="#FF0000">"string"</font><font color="#990000">);</font>
        <b><font color="#0000FF">const</font></b> encrypted_img <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">encrypt</font></b><font color="#990000">(</font>file<font color="#990000">,</font> shared_key<font color="#990000">,</font> <font color="#FF0000">"string"</font><font color="#990000">);</font>
        <i><font color="#9A1900">// const encrypted_imageMetadata = await this.encrypt(JSON.stringify({ imageId: imgId, imageKey: imgKey, previewId: previewId, previewKey: previewKey }), shared_key, "string");</font></i>
        <b><font color="#0000FF">const</font></b> encrypted_imageMetadata <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">encrypt</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> imageId<font color="#990000">:</font> imgId<font color="#990000">,</font> previewId<font color="#990000">:</font> previewId<font color="#990000">,</font> imageKey<font color="#990000">:</font> imgKey<font color="#990000">,</font> previewKey<font color="#990000">:</font> previewKey <font color="#FF0000">}</font><font color="#990000">),</font> shared_key<font color="#990000">,</font> <font color="#FF0000">"string"</font><font color="#990000">);</font>

        contents <font color="#990000">=</font> <font color="#FF0000">{</font> <font color="#990000">...</font>contents<font color="#990000">,</font> encrypted<font color="#990000">:</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> contents<font color="#990000">:</font> _content<font color="#990000">,</font> sender_pubKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">,</font> image<font color="#990000">:</font> encrypted_img<font color="#990000">,</font> imageMetaData<font color="#990000">:</font> encrypted_imageMetadata <font color="#FF0000">}</font><font color="#990000">;</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        <b><font color="#0000FF">const</font></b> _sign <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sign</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>personal_signKey<font color="#990000">,</font> message<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">].</font>text<font color="#990000">);</font>
        <b><font color="#0000FF">const</font></b> _image_sign <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sign</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>personal_signKey<font color="#990000">,</font> file<font color="#990000">);</font>
        <b><font color="#0000FF">const</font></b> _imageMetadata <font color="#990000">=</font> <font color="#FF0000">{</font> imageId<font color="#990000">:</font> imgId<font color="#990000">,</font> previewId<font color="#990000">:</font> previewId<font color="#990000">,</font> imageKey<font color="#990000">:</font> imgKey<font color="#990000">,</font> previewKey<font color="#990000">:</font> previewKey <font color="#FF0000">}</font>
        <b><font color="#0000FF">const</font></b> _imageMetadata_string <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>_imageMetadata<font color="#990000">);</font>
        <i><font color="#9A1900">// const _imageMetadata_sign = await this.sign(this.state.keys.personal_signKey, JSON.stringify(_imageMetadata))</font></i>
        <b><font color="#0000FF">const</font></b> _imageMetadata_sign <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sign</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>personal_signKey<font color="#990000">,</font> _imageMetadata_string<font color="#990000">)</font>
        contents <font color="#990000">=</font> <font color="#FF0000">{</font> encrypted<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> contents<font color="#990000">:</font> message<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">].</font>text<font color="#990000">,</font> sender_pubKey<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">,</font> sign<font color="#990000">:</font> _sign<font color="#990000">,</font> image<font color="#990000">:</font> file<font color="#990000">,</font> image_sign<font color="#990000">:</font> _image_sign<font color="#990000">,</font> imageMetaData<font color="#990000">:</font> _imageMetadata_string<font color="#990000">,</font> imageMetadata_sign<font color="#990000">:</font> _imageMetadata_sign <font color="#FF0000">}</font><font color="#990000">;</font>

      <font color="#FF0000">}</font>
      contents<font color="#990000">.</font>sender_username <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>username<font color="#990000">;</font>
      msg <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">wrapMessage</font></b><font color="#990000">(</font>contents<font color="#990000">);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>msg<font color="#990000">.</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemInfo</font></b><font color="#990000">(</font>msg<font color="#990000">.</font>error<font color="#990000">);</font>
        <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>

      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>currentWebSocket<font color="#990000">)</font> <font color="#FF0000">{</font>

        <i><font color="#9A1900">// this.currentWebSocket.send(JSON.stringify(contents));      Version before doing E2EE</font></i>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>currentWebSocket<font color="#990000">.</font><b><font color="#000000">send</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>msg<font color="#990000">));</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>fullStorePromise<font color="#990000">,</font> previewStorePromise<font color="#990000">);</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fullStorePromise <font color="#990000">!==</font> <font color="#FF0000">''</font><font color="#990000">)</font> <font color="#FF0000">{</font>
          fullStorePromise<font color="#990000">.</font><b><font color="#000000">then</font></b><font color="#990000">(</font><b><font color="#000000">async</font></b> <font color="#990000">(</font>controlData<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
            <i><font color="#9A1900">// console.log(controlData);</font></i>
            let control_msg <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">wrapMessage</font></b><font color="#990000">(</font><font color="#FF0000">{</font> <font color="#990000">...</font>controlData<font color="#990000">,</font> control<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">);</font>
            <b><font color="#0000FF">this</font></b><font color="#990000">.</font>currentWebSocket<font color="#990000">.</font><b><font color="#000000">send</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>control_msg<font color="#990000">));</font>
          <font color="#FF0000">}</font><font color="#990000">);</font>
        <font color="#FF0000">}</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>previewStorePromise <font color="#990000">!==</font> <font color="#FF0000">''</font><font color="#990000">)</font> <font color="#FF0000">{</font>
          previewStorePromise<font color="#990000">.</font><b><font color="#000000">then</font></b><font color="#990000">(</font><b><font color="#000000">async</font></b> <font color="#990000">(</font>controlData<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
            let control_msg <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">wrapMessage</font></b><font color="#990000">(</font><font color="#FF0000">{</font> <font color="#990000">...</font>controlData<font color="#990000">,</font> control<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">);</font>
            <b><font color="#0000FF">this</font></b><font color="#990000">.</font>currentWebSocket<font color="#990000">.</font><b><font color="#000000">send</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>control_msg<font color="#990000">));</font>
          <font color="#FF0000">}</font><font color="#990000">);</font>
        <font color="#FF0000">}</font>

      <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemMessage</font></b><font color="#990000">(</font><font color="#FF0000">"Error: Lost connection"</font><font color="#990000">)</font>
      <font color="#FF0000">}</font>

    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// console.log(e);</font></i>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemInfo</font></b><font color="#990000">(</font><font color="#FF0000">'Could not send message'</font><font color="#990000">);</font>
      JwModal<font color="#990000">.</font><b><font color="#000000">open</font></b><font color="#990000">(</font><font color="#FF0000">'room-response'</font><font color="#990000">,</font> <font color="#FF0000">'Sending message failed, error from server: '</font> <font color="#990000">+</font> error<font color="#990000">.</font>message<font color="#990000">);</font>
    <font color="#FF0000">}</font>

    <i><font color="#9A1900">// Reset the 'reply_to' data once message is sent</font></i>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">delete</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>reply_to<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>reply_encryptionKey<font color="#990000">;</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">removeInputFiles</font></b><font color="#990000">();</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// we ignore problems</font></i>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <i><font color="#9A1900">// ##########################   FUNCTIONS TO HANDLE ANY AND ALL CRYPTO  ####################################</font></i>


  <b><font color="#000000">extractPubKey</font></b><font color="#990000">(</font>privateKey<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      let pubKey <font color="#990000">=</font> <font color="#FF0000">{</font> <font color="#990000">...</font>privateKey <font color="#FF0000">}</font>
      <b><font color="#0000FF">delete</font></b> pubKey<font color="#990000">.</font>d<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> pubKey<font color="#990000">.</font>dp<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> pubKey<font color="#990000">.</font>dq<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> pubKey<font color="#990000">.</font>q<font color="#990000">;</font>
      <b><font color="#0000FF">delete</font></b> pubKey<font color="#990000">.</font>qi<font color="#990000">;</font>
      pubKey<font color="#990000">.</font>key_ops <font color="#990000">=</font> <font color="#990000">[]</font>
      <b><font color="#0000FF">return</font></b> pubKey<font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">generateKeys</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      let keyPair <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">generateKey</font></b><font color="#990000">(</font>
        <font color="#FF0000">{</font>
          name<font color="#990000">:</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font>
          namedCurve<font color="#990000">:</font> <font color="#FF0000">"P-384"</font>
        <font color="#FF0000">}</font><font color="#990000">,</font>
        <b><font color="#0000FF">true</font></b><font color="#990000">,</font>
        <font color="#990000">[</font><font color="#FF0000">"deriveKey"</font><font color="#990000">]</font>
      <font color="#990000">);</font>

      <b><font color="#0000FF">return</font></b> keyPair<font color="#990000">;</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Failed to generate keys'</font> <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">importKey</font></b><font color="#990000">(</font>format<font color="#990000">,</font> key<font color="#990000">,</font> type<font color="#990000">,</font> extractable<font color="#990000">,</font> keyUsages<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> keyAlgorithms <font color="#990000">=</font> <font color="#FF0000">{</font>
      ECDH<font color="#990000">:</font> <font color="#FF0000">{</font>
        name<font color="#990000">:</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font>
        namedCurve<font color="#990000">:</font> <font color="#FF0000">"P-384"</font>
      <font color="#FF0000">}</font><font color="#990000">,</font>
      AES<font color="#990000">:</font> <font color="#FF0000">{</font>
        name<font color="#990000">:</font> <font color="#FF0000">"AES-GCM"</font>
      <font color="#FF0000">}</font><font color="#990000">,</font>
      PBKDF2<font color="#990000">:</font> <font color="#FF0000">"PBKDF2"</font>
    <font color="#FF0000">}</font>
    let _key<font color="#990000">;</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      _key <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font>
        format<font color="#990000">,</font>
        key<font color="#990000">,</font>
        keyAlgorithms<font color="#990000">[</font>type<font color="#990000">],</font>
        extractable<font color="#990000">,</font>
        keyUsages
      <font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      _key <font color="#990000">=</font> <font color="#FF0000">{</font> error<font color="#990000">:</font> error <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> _key<font color="#990000">;</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">deriveKey</font></b><font color="#990000">(</font>privateKey<font color="#990000">,</font> publicKey<font color="#990000">,</font> type<font color="#990000">,</font> extractable<font color="#990000">,</font> keyUsages<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> keyAlgorithms <font color="#990000">=</font> <font color="#FF0000">{</font>
      AES<font color="#990000">:</font> <font color="#FF0000">{</font>
        name<font color="#990000">:</font> <font color="#FF0000">"AES-GCM"</font><font color="#990000">,</font>
        length<font color="#990000">:</font> <font color="#993399">256</font>
      <font color="#FF0000">}</font><font color="#990000">,</font>
      HMAC<font color="#990000">:</font> <font color="#FF0000">{</font>
        name<font color="#990000">:</font> <font color="#FF0000">"HMAC"</font><font color="#990000">,</font>
        hash<font color="#990000">:</font> <font color="#FF0000">"SHA-256"</font><font color="#990000">,</font>
        length<font color="#990000">:</font> <font color="#993399">256</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font>
        <font color="#FF0000">{</font>
          name<font color="#990000">:</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font>
          <b><font color="#0000FF">public</font></b><font color="#990000">:</font> publicKey
        <font color="#FF0000">}</font><font color="#990000">,</font>
        privateKey<font color="#990000">,</font>
        keyAlgorithms<font color="#990000">[</font>type<font color="#990000">],</font>
        extractable<font color="#990000">,</font>
        keyUsages
      <font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Could not derive keys"</font> <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">getImageKey</font></b><font color="#990000">(</font>imageHash<font color="#990000">,</font> _salt<font color="#990000">)</font> <font color="#FF0000">{</font>

    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      let keyMaterial <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"raw"</font><font color="#990000">,</font> utils<font color="#990000">.</font><b><font color="#000000">base64ToArrayBuffer</font></b><font color="#990000">(</font><b><font color="#000000">decodeURIComponent</font></b><font color="#990000">(</font>imageHash<font color="#990000">)),</font> <font color="#FF0000">"PBKDF2"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"deriveBits"</font><font color="#990000">,</font> <font color="#FF0000">"deriveKey"</font><font color="#990000">]);</font>

      <i><font color="#9A1900">// TODO - Support deriving from PBKDF2 in deriveKey function</font></i>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>_salt<font color="#990000">)</font>
      let key <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font>
        <font color="#FF0000">{</font>
          <font color="#FF0000">"name"</font><font color="#990000">:</font> <font color="#FF0000">"PBKDF2"</font><font color="#990000">,</font>
          <i><font color="#9A1900">// salt: window.crypto.getRandomValues(new Uint8Array(16)),</font></i>
          salt<font color="#990000">:</font> _salt<font color="#990000">,</font>
          <font color="#FF0000">"iterations"</font><font color="#990000">:</font> <font color="#993399">100000</font><font color="#990000">,</font> <i><font color="#9A1900">// small is fine, we want it snappy</font></i>
          <font color="#FF0000">"hash"</font><font color="#990000">:</font> <font color="#FF0000">"SHA-256"</font>
        <font color="#FF0000">}</font><font color="#990000">,</font>
        keyMaterial<font color="#990000">,</font>
        <font color="#FF0000">{</font> <font color="#FF0000">"name"</font><font color="#990000">:</font> <font color="#FF0000">"AES-GCM"</font><font color="#990000">,</font> <font color="#FF0000">"length"</font><font color="#990000">:</font> <font color="#993399">256</font> <font color="#FF0000">}</font><font color="#990000">,</font>
        <b><font color="#0000FF">true</font></b><font color="#990000">,</font>
        <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">,</font> <font color="#FF0000">"decrypt"</font><font color="#990000">]</font>
      <font color="#990000">);</font>
      <i><font color="#9A1900">// return key;</font></i>
      <b><font color="#0000FF">return</font></b> key<font color="#990000">;</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> e <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">encrypt</font></b><font color="#990000">(</font>contents<font color="#990000">,</font> secret_key <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">,</font> outputType <font color="#990000">=</font> <font color="#FF0000">"string"</font><font color="#990000">,</font> _iv <font color="#990000">=</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>contents <font color="#990000">===</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">const</font></b> iv <font color="#990000">=</font> _iv <font color="#990000">===</font> <b><font color="#0000FF">null</font></b> <font color="#990000">?</font> window<font color="#990000">.</font>crypto<font color="#990000">.</font><b><font color="#000000">getRandomValues</font></b><font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font><font color="#993399">12</font><font color="#990000">))</font> <font color="#990000">:</font> _iv<font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> algorithm <font color="#990000">=</font> <font color="#FF0000">{</font>
        name<font color="#990000">:</font> <font color="#FF0000">"AES-GCM"</font><font color="#990000">,</font>
        iv<font color="#990000">:</font> iv
      <font color="#FF0000">}</font><font color="#990000">;</font>
      let key <font color="#990000">=</font> secret_key<font color="#990000">;</font>
      let data <font color="#990000">=</font> contents<font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> encoder <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TextEncoder</font></b><font color="#990000">();</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">typeof</font></b> contents <font color="#990000">===</font> <font color="#FF0000">'string'</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        data <font color="#990000">=</font> encoder<font color="#990000">.</font><b><font color="#000000">encode</font></b><font color="#990000">(</font>contents<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      let encrypted<font color="#990000">;</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        encrypted <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">encrypt</font></b><font color="#990000">(</font>algorithm<font color="#990000">,</font> key<font color="#990000">,</font> data<font color="#990000">);</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">);</font>
        <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Encryption failed"</font> <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>outputType <font color="#990000">===</font> <font color="#FF0000">'string'</font><font color="#990000">)</font> <font color="#990000">?</font> <font color="#FF0000">{</font> content<font color="#990000">:</font> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>utils<font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>encrypted<font color="#990000">)),</font> iv<font color="#990000">:</font> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>utils<font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>iv<font color="#990000">))</font> <font color="#FF0000">}</font> <font color="#990000">:</font> <font color="#FF0000">{</font> content<font color="#990000">:</font> encrypted<font color="#990000">,</font> iv<font color="#990000">:</font> iv <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> e <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">decrypt</font></b><font color="#990000">(</font>secretKey<font color="#990000">,</font> contents<font color="#990000">,</font> outputType <font color="#990000">=</font> <font color="#FF0000">"string"</font><font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> ciphertext <font color="#990000">=</font> <b><font color="#0000FF">typeof</font></b> contents<font color="#990000">.</font>content <font color="#990000">===</font> <font color="#FF0000">'string'</font> <font color="#990000">?</font> utils<font color="#990000">.</font><b><font color="#000000">base64ToArrayBuffer</font></b><font color="#990000">(</font><b><font color="#000000">decodeURIComponent</font></b><font color="#990000">(</font>contents<font color="#990000">.</font>content<font color="#990000">))</font> <font color="#990000">:</font> contents<font color="#990000">.</font>content<font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> iv <font color="#990000">=</font> <b><font color="#0000FF">typeof</font></b> contents<font color="#990000">.</font>iv <font color="#990000">===</font> <font color="#FF0000">'string'</font> <font color="#990000">?</font> utils<font color="#990000">.</font><b><font color="#000000">base64ToArrayBuffer</font></b><font color="#990000">(</font><b><font color="#000000">decodeURIComponent</font></b><font color="#990000">(</font>contents<font color="#990000">.</font>iv<font color="#990000">))</font> <font color="#990000">:</font> contents<font color="#990000">.</font>iv<font color="#990000">;</font>
      let decrypted <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">decrypt</font></b><font color="#990000">(</font>
        <font color="#FF0000">{</font>
          name<font color="#990000">:</font> <font color="#FF0000">"AES-GCM"</font><font color="#990000">,</font>
          iv<font color="#990000">:</font> iv
        <font color="#FF0000">}</font><font color="#990000">,</font>
        secretKey<font color="#990000">,</font>
        ciphertext
      <font color="#990000">);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outputType <font color="#990000">===</font> <font color="#FF0000">"string"</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> plaintext<font color="#990000">:</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TextDecoder</font></b><font color="#990000">().</font><b><font color="#000000">decode</font></b><font color="#990000">(</font>decrypted<font color="#990000">)</font> <font color="#FF0000">}</font><font color="#990000">;</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> plaintext<font color="#990000">:</font> decrypted <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// console.log(e);</font></i>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> plaintext<font color="#990000">:</font> <font color="#FF0000">"(whispered)"</font> <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">sign</font></b><font color="#990000">(</font>secretKey<font color="#990000">,</font> contents<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> encoder <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TextEncoder</font></b><font color="#990000">();</font>
      <b><font color="#0000FF">const</font></b> encoded <font color="#990000">=</font> encoder<font color="#990000">.</font><b><font color="#000000">encode</font></b><font color="#990000">(</font>contents<font color="#990000">);</font>
      let sign<font color="#990000">;</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        sign <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">sign</font></b><font color="#990000">(</font>
          <font color="#FF0000">'HMAC'</font><font color="#990000">,</font>
          secretKey<font color="#990000">,</font>
          encoded
        <font color="#990000">);</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>utils<font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>sign<font color="#990000">));</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">);</font>
        <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Failed to sign content"</font> <font color="#FF0000">}</font><font color="#990000">;</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> error <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">verify</font></b><font color="#990000">(</font>secretKey<font color="#990000">,</font> sign<font color="#990000">,</font> contents<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> _sign <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">base64ToArrayBuffer</font></b><font color="#990000">(</font><b><font color="#000000">decodeURIComponent</font></b><font color="#990000">(</font>sign<font color="#990000">));</font>
      <b><font color="#0000FF">const</font></b> encoder <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TextEncoder</font></b><font color="#990000">();</font>
      <b><font color="#0000FF">const</font></b> encoded <font color="#990000">=</font> encoder<font color="#990000">.</font><b><font color="#000000">encode</font></b><font color="#990000">(</font>contents<font color="#990000">);</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        let verified <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">verify</font></b><font color="#990000">(</font>
          <font color="#FF0000">'HMAC'</font><font color="#990000">,</font>
          secretKey<font color="#990000">,</font>
          _sign<font color="#990000">,</font>
          encoded
        <font color="#990000">);</font>
        <b><font color="#0000FF">return</font></b> verified<font color="#990000">;</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">areKeysSame</font></b><font color="#990000">(</font>key1<font color="#990000">,</font> key2<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>key1 <font color="#990000">!=</font> <b><font color="#0000FF">null</font></b> <font color="#990000">&amp;&amp;</font> key2 <font color="#990000">!=</font> <b><font color="#0000FF">null</font></b> <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">typeof</font></b> key1 <font color="#990000">===</font> <font color="#FF0000">'object'</font> <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">typeof</font></b> key2 <font color="#990000">===</font> <font color="#FF0000">'object'</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> key1<font color="#990000">[</font><font color="#FF0000">'x'</font><font color="#990000">]</font> <font color="#990000">===</font> key2<font color="#990000">[</font><font color="#FF0000">'x'</font><font color="#990000">]</font> <font color="#990000">&amp;&amp;</font> key1<font color="#990000">[</font><font color="#FF0000">'y'</font><font color="#990000">]</font> <font color="#990000">===</font> key2<font color="#990000">[</font><font color="#FF0000">'y'</font><font color="#990000">];</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
  <font color="#FF0000">}</font>


  <i><font color="#9A1900">// #######################   MISC HELPER FUNCTIONS   ###############################</font></i>


  async <b><font color="#000000">getRoomCapacity</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#000000">fetch</font></b><font color="#990000">(</font>ROOM_SERVER <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/getRoomCapacity"</font><font color="#990000">,</font> <font color="#FF0000">{</font> credentials<font color="#990000">:</font> <font color="#FF0000">'include'</font> <font color="#FF0000">}</font><font color="#990000">).</font><b><font color="#000000">then</font></b><font color="#990000">(</font>resp <font color="#990000">=&gt;</font> resp<font color="#990000">.</font><b><font color="#000000">json</font></b><font color="#990000">().</font><b><font color="#000000">then</font></b><font color="#990000">(</font>data <font color="#990000">=&gt;</font> data<font color="#990000">.</font>capacity <font color="#990000">?</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> roomCapacity<font color="#990000">:</font> data<font color="#990000">.</font>capacity <font color="#FF0000">}</font><font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> adminError<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">)));</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">updateRoomCapacity</font></b><font color="#990000">(</font>roomCapacity<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#000000">fetch</font></b><font color="#990000">(</font>ROOM_SERVER <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/updateRoomCapacity?capacity="</font> <font color="#990000">+</font> roomCapacity<font color="#990000">,</font> <font color="#FF0000">{</font> credentials<font color="#990000">:</font> <font color="#FF0000">'include'</font> <font color="#FF0000">}</font><font color="#990000">).</font><b><font color="#000000">then</font></b><font color="#990000">(</font>data <font color="#990000">=&gt;</font> JwModal<font color="#990000">.</font><b><font color="#000000">open</font></b><font color="#990000">(</font><font color="#FF0000">'admin-response'</font><font color="#990000">,</font> <font color="#FF0000">'this worked!'</font><font color="#990000">));</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">getAdminData</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    let request<font color="#990000">=</font> <font color="#FF0000">{</font>credentials<font color="#990000">:</font> <font color="#FF0000">"include"</font><font color="#FF0000">}</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>process<font color="#990000">.</font>env<font color="#990000">.</font>REACT_APP_ROOM_SERVER <font color="#990000">!==</font> <font color="#FF0000">'s_socket.privacy.app'</font> <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>room_owner<font color="#990000">)</font> <font color="#FF0000">{</font>
      let token_data <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Date</font></b><font color="#990000">().</font><b><font color="#000000">getTime</font></b><font color="#990000">().</font><b><font color="#000000">toString</font></b><font color="#990000">();</font>
      let token_sign <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sign</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>personal_signKey<font color="#990000">,</font> token_data<font color="#990000">);</font>
      request<font color="#990000">.</font>headers<font color="#990000">=</font> <font color="#FF0000">{</font>authorization<font color="#990000">:</font> token_data <font color="#990000">+</font> <font color="#FF0000">"."</font> <font color="#990000">+</font> token_sign<font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    <b><font color="#000000">fetch</font></b><font color="#990000">(</font>ROOM_SERVER <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/getAdminData"</font><font color="#990000">,</font> request<font color="#990000">).</font><b><font color="#000000">then</font></b><font color="#990000">(</font>resp <font color="#990000">=&gt;</font> resp<font color="#990000">.</font><b><font color="#000000">json</font></b><font color="#990000">().</font><b><font color="#000000">then</font></b><font color="#990000">(</font>data <font color="#990000">=&gt;</font> data<font color="#990000">.</font>error <font color="#990000">?</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> adminError<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> roomCapacity<font color="#990000">:</font> data<font color="#990000">.</font>capacity<font color="#990000">,</font> joinRequests<font color="#990000">:</font> data<font color="#990000">.</font>join_requests <font color="#FF0000">}</font><font color="#990000">)))</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">saveUsername</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> newUsername <font color="#990000">=</font> document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'username-input'</font><font color="#990000">).</font>value
      let user <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>changeUsername
      <b><font color="#0000FF">const</font></b> user_pubKey <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>user<font color="#990000">.</font>_id<font color="#990000">);</font>
      let contacts <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>contacts
      let _messages <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#990000">;</font>
      _messages<font color="#990000">.</font><b><font color="#000000">forEach</font></b><font color="#990000">(</font>message <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>message<font color="#990000">.</font>user<font color="#990000">.</font>_id <font color="#990000">===</font> user<font color="#990000">.</font>_id<font color="#990000">)</font> <font color="#FF0000">{</font>
          message<font color="#990000">.</font>user<font color="#990000">.</font>name <font color="#990000">=</font> message<font color="#990000">.</font>user<font color="#990000">.</font>name<font color="#990000">.</font><b><font color="#000000">replace</font></b><font color="#990000">(</font><font color="#FF0000">'('</font> <font color="#990000">+</font> contacts<font color="#990000">[</font>user_pubKey<font color="#990000">.</font>x <font color="#990000">+</font> <font color="#FF0000">' '</font> <font color="#990000">+</font> user_pubKey<font color="#990000">.</font>y<font color="#990000">]</font> <font color="#990000">+</font> <font color="#FF0000">')'</font><font color="#990000">,</font> <font color="#FF0000">'('</font> <font color="#990000">+</font> newUsername <font color="#990000">+</font> <font color="#FF0000">')'</font><font color="#990000">);</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font><font color="#990000">);</font>
      contacts<font color="#990000">[</font>user_pubKey<font color="#990000">.</font>x <font color="#990000">+</font> <font color="#FF0000">' '</font> <font color="#990000">+</font> user_pubKey<font color="#990000">.</font>y<font color="#990000">]</font> <font color="#990000">=</font> newUsername<font color="#990000">;</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> changeUsername<font color="#990000">:</font> <font color="#FF0000">{</font> _id<font color="#990000">:</font> <font color="#FF0000">''</font><font color="#990000">,</font> name<font color="#990000">:</font> <font color="#FF0000">''</font> <font color="#FF0000">}</font><font color="#990000">,</font> messages<font color="#990000">:</font> _messages <font color="#FF0000">}</font><font color="#990000">);</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font><b><font color="#000000">updateContacts</font></b><font color="#990000">(</font>contacts<font color="#990000">);</font>
      document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'change-username-close-btn'</font><font color="#990000">).</font><b><font color="#000000">click</font></b><font color="#990000">();</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> e <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">getUsername</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> username <font color="#990000">=</font> localStorage<font color="#990000">.</font><b><font color="#000000">getItem</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">'_username'</font><font color="#990000">);</font>
    <b><font color="#0000FF">return</font></b> username <font color="#990000">===</font> <b><font color="#0000FF">null</font></b> <font color="#990000">?</font> <font color="#FF0000">''</font> <font color="#990000">:</font> username<font color="#990000">;</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">acceptVisitor</font></b><font color="#990000">(</font>pubKey<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      let updatedRequests <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>joinRequests<font color="#990000">;</font>
      updatedRequests<font color="#990000">.</font><b><font color="#000000">splice</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>joinRequests<font color="#990000">.</font><b><font color="#000000">indexOf</font></b><font color="#990000">(</font>pubKey<font color="#990000">),</font> <font color="#993399">1</font><font color="#990000">);</font>
      <i><font color="#9A1900">// console.log(pubKey);</font></i>
      <b><font color="#0000FF">const</font></b> shared_key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>privateKey<font color="#990000">,</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>pubKey<font color="#990000">),</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[]),</font> <font color="#FF0000">"AES"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">,</font> <font color="#FF0000">"decrypt"</font><font color="#990000">]);</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> joinRequests<font color="#990000">:</font> updatedRequests <font color="#FF0000">}</font><font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> _encrypted_locked_key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">encrypt</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_locked_key<font color="#990000">),</font> shared_key<font color="#990000">,</font> <font color="#FF0000">"string"</font><font color="#990000">)</font>
      <i><font color="#9A1900">// console.log("Will now fetch")</font></i>
      <b><font color="#000000">fetch</font></b><font color="#990000">(</font>ROOM_SERVER <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/acceptVisitor"</font><font color="#990000">,</font> <font color="#FF0000">{</font>
        method<font color="#990000">:</font> <font color="#FF0000">"POST"</font><font color="#990000">,</font>
        body<font color="#990000">:</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> pubKey<font color="#990000">:</font> pubKey<font color="#990000">,</font> lockedKey<font color="#990000">:</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>_encrypted_locked_key<font color="#990000">)</font> <font color="#FF0000">}</font><font color="#990000">),</font>
        headers<font color="#990000">:</font> <font color="#FF0000">{</font>
          <font color="#FF0000">"Content-Type"</font><font color="#990000">:</font> <font color="#FF0000">"application/json"</font>
        <font color="#FF0000">}</font><font color="#990000">,</font>
        credentials<font color="#990000">:</font> <font color="#FF0000">'include'</font>
      <font color="#FF0000">}</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> e <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">lockRoom</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>locked_key <font color="#990000">==</font> <b><font color="#0000FF">null</font></b> <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>room_admin<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">const</font></b> _locked_key <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">generateKey</font></b><font color="#990000">(</font><font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">"AES-GCM"</font><font color="#990000">,</font> length<font color="#990000">:</font> <font color="#993399">256</font> <font color="#FF0000">}</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">,</font> <font color="#FF0000">"decrypt"</font><font color="#990000">]);</font>
        <b><font color="#0000FF">const</font></b> _exportable_locked_key <font color="#990000">=</font> await window<font color="#990000">.</font>crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">exportKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> _locked_key<font color="#990000">);</font>
        localStorage<font color="#990000">.</font><b><font color="#000000">setItem</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">'_lockedKey'</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>_exportable_locked_key<font color="#990000">));</font>
        <b><font color="#0000FF">const</font></b> lock_success <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">await</font></b> <font color="#990000">(</font>await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>ROOM_SERVER <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/lockRoom"</font><font color="#990000">,</font> <font color="#FF0000">{</font> credentials<font color="#990000">:</font> <font color="#FF0000">'include'</font> <font color="#FF0000">}</font><font color="#990000">)).</font><b><font color="#000000">json</font></b><font color="#990000">()).</font>locked<font color="#990000">;</font>
        <i><font color="#9A1900">// console.log(lock_success);</font></i>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>lock_success<font color="#990000">)</font> <font color="#FF0000">{</font>
          <b><font color="#000000">await</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">acceptVisitor</font></b><font color="#990000">(</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">))).</font><b><font color="#000000">json</font></b><font color="#990000">();</font>
          <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> locked<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">);</font>
          window<font color="#990000">.</font>location<font color="#990000">.</font><b><font color="#000000">reload</font></b><font color="#990000">();</font>  <i><font color="#9A1900">// Need a better way to reload</font></i>
          <i><font color="#9A1900">// await this.getJoinRequests();</font></i>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> e <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">isRoomLocked</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> locked_json <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">await</font></b> <font color="#990000">(</font>await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>ROOM_SERVER <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/roomLocked"</font><font color="#990000">,</font> <font color="#FF0000">{</font> credentials<font color="#990000">:</font> <font color="#FF0000">'include'</font> <font color="#FF0000">}</font><font color="#990000">)).</font><b><font color="#000000">json</font></b><font color="#990000">());</font>
      <i><font color="#9A1900">// console.log(locked)</font></i>
      <b><font color="#0000FF">return</font></b> locked_json<font color="#990000">.</font>locked<font color="#990000">;</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> e <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">getJoinRequests</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> joinRequests <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">await</font></b> <font color="#990000">(</font>await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>ROOM_SERVER <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/getJoinRequests"</font><font color="#990000">,</font> <font color="#FF0000">{</font> credentials<font color="#990000">:</font> <font color="#FF0000">'include'</font> <font color="#FF0000">}</font><font color="#990000">)).</font><b><font color="#000000">json</font></b><font color="#990000">())</font>
      <i><font color="#9A1900">// console.log(joinRequests)</font></i>
      joinRequests<font color="#990000">.</font>error <font color="#990000">?</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> adminError<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">)</font> <font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> joinRequests<font color="#990000">:</font> joinRequests<font color="#990000">.</font>join_requests <font color="#FF0000">}</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">setMOTD</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>room_owner<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">const</font></b> msg <font color="#990000">=</font> document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'motd'</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'motd'</font><font color="#990000">).</font>value <font color="#990000">!==</font> <font color="#FF0000">"Enter Message of the Day here"</font> <font color="#990000">?</font> document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'motd'</font><font color="#990000">).</font>value <font color="#990000">:</font> <font color="#FF0000">''</font><font color="#990000">;</font>
        <b><font color="#000000">fetch</font></b><font color="#990000">(</font>ROOM_SERVER <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/motd"</font><font color="#990000">,</font> <font color="#FF0000">{</font>
          method<font color="#990000">:</font> <font color="#FF0000">"POST"</font><font color="#990000">,</font>
          body<font color="#990000">:</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> motd<font color="#990000">:</font> msg <font color="#FF0000">}</font><font color="#990000">),</font>
          headers<font color="#990000">:</font> <font color="#FF0000">{</font>
            <font color="#FF0000">"Content-Type"</font><font color="#990000">:</font> <font color="#FF0000">"application/json"</font>
          <font color="#FF0000">}</font>
        <font color="#FF0000">}</font><font color="#990000">);</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> motd<font color="#990000">:</font> msg <font color="#FF0000">}</font><font color="#990000">);</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'motd-close-btn'</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'motd-close-btn'</font><font color="#990000">).</font><b><font color="#000000">click</font></b><font color="#990000">();</font>
  <font color="#FF0000">}</font>


  <i><font color="#9A1900">// handleReply() function is only available to room owners. If room owner selects "Reply To" on long pressing a message, this function sets state with shared keys for the owner and the message sender they want to reply to</font></i>
  async <b><font color="#000000">handleReply</font></b><font color="#990000">(</font>user<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>room_owner<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">const</font></b> recipient_pubKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">importKey</font></b><font color="#990000">(</font><font color="#FF0000">"jwk"</font><font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>user<font color="#990000">.</font>_id<font color="#990000">),</font> <font color="#FF0000">"ECDH"</font><font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> <font color="#990000">[]);</font>
        <i><font color="#9A1900">// const reply_encryptionKey = await this.deriveSecretKey(this.state.keys.privateKey, recipient_pubKey)</font></i>
        <b><font color="#0000FF">const</font></b> reply_encryptionKey <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">deriveKey</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>privateKey<font color="#990000">,</font> recipient_pubKey<font color="#990000">,</font> <font color="#FF0000">"AES"</font><font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> <font color="#990000">[</font><font color="#FF0000">"encrypt"</font><font color="#990000">,</font> <font color="#FF0000">"decrypt"</font><font color="#990000">])</font>
        <i><font color="#9A1900">// const reply_encryptionKey = this.state.sharedKeys[JSON.parse(user._id)];</font></i>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> reply_encryptionKey<font color="#990000">:</font> reply_encryptionKey<font color="#990000">,</font> reply_to<font color="#990000">:</font> user <font color="#FF0000">}</font><font color="#990000">);</font>
        JwModal<font color="#990000">.</font><b><font color="#000000">open</font></b><font color="#990000">(</font><font color="#FF0000">'whisper-user'</font><font color="#990000">);</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <i><font color="#9A1900">// #########################    FUNCTIONS TO HANDLE ALL IMAGE PROCESSING   ###########################################</font></i>


  <i><font color="#9A1900">// TODO - can be optimized (asynchronized more) to return the hashes once calculated and then do all the encryption stuff.</font></i>
  async <b><font color="#000000">saveImage</font></b><font color="#990000">(</font>image<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> previewImage <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">padImage</font></b><font color="#990000">(</font><b><font color="#000000">await</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">restrictPhoto</font></b><font color="#990000">(</font>image<font color="#990000">,</font> <font color="#993399">4096</font><font color="#990000">,</font> <font color="#FF0000">"image/jpeg"</font><font color="#990000">,</font> <font color="#993399">0.92</font><font color="#990000">)).</font><b><font color="#000000">arrayBuffer</font></b><font color="#990000">());</font>
    <b><font color="#0000FF">const</font></b> previewHash <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">generateImageHash</font></b><font color="#990000">(</font>previewImage<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> fullImage <font color="#990000">=</font> image<font color="#990000">.</font>size <font color="#990000">&gt;</font> <font color="#993399">15728640</font> <font color="#990000">?</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">padImage</font></b><font color="#990000">(</font><b><font color="#000000">await</font></b> <font color="#990000">(</font>await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">restrictPhoto</font></b><font color="#990000">(</font>image<font color="#990000">,</font> <font color="#993399">15360</font><font color="#990000">,</font> <font color="#FF0000">"image/jpeg"</font><font color="#990000">,</font> <font color="#993399">0.92</font><font color="#990000">)).</font><b><font color="#000000">arrayBuffer</font></b><font color="#990000">())</font> <font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">padImage</font></b><font color="#990000">(</font>await image<font color="#990000">.</font><b><font color="#000000">arrayBuffer</font></b><font color="#990000">());</font>
    <b><font color="#0000FF">const</font></b> fullHash <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">generateImageHash</font></b><font color="#990000">(</font>fullImage<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> previewStorePromise <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">storeImage</font></b><font color="#990000">(</font>previewImage<font color="#990000">,</font> previewHash<font color="#990000">.</font>id<font color="#990000">,</font> previewHash<font color="#990000">.</font>key<font color="#990000">,</font> <font color="#FF0000">'p'</font><font color="#990000">).</font><b><font color="#000000">then</font></b><font color="#990000">(</font>_x <font color="#990000">=&gt;</font> <font color="#FF0000">{</font> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>_x<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">'error'</font><font color="#990000">))</font>  <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemMessage</font></b><font color="#990000">(</font><font color="#FF0000">'Could not store preview: '</font> <font color="#990000">+</font> _x<font color="#990000">[</font><font color="#FF0000">'error'</font><font color="#990000">]);</font> <b><font color="#0000FF">return</font></b> _x<font color="#990000">;</font> <font color="#FF0000">}</font><font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> fullStorePromise <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">storeImage</font></b><font color="#990000">(</font>fullImage<font color="#990000">,</font> fullHash<font color="#990000">.</font>id<font color="#990000">,</font> fullHash<font color="#990000">.</font>key<font color="#990000">,</font> <font color="#FF0000">'f'</font><font color="#990000">).</font><b><font color="#000000">then</font></b><font color="#990000">(</font>_x <font color="#990000">=&gt;</font> <font color="#FF0000">{</font> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>_x<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">'error'</font><font color="#990000">))</font>  <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemMessage</font></b><font color="#990000">(</font><font color="#FF0000">'Could not store full image: '</font> <font color="#990000">+</font> _x<font color="#990000">[</font><font color="#FF0000">'error'</font><font color="#990000">]);</font> <b><font color="#0000FF">return</font></b> _x<font color="#990000">;</font> <font color="#FF0000">}</font><font color="#990000">);</font>

    <i><font color="#9A1900">// return { full: { id: fullHash.id, key: fullHash.key }, preview: { id: previewHash.id, key: previewHash.key } }</font></i>
    <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> full<font color="#990000">:</font> fullHash<font color="#990000">.</font>id<font color="#990000">,</font> preview<font color="#990000">:</font> previewHash<font color="#990000">.</font>id<font color="#990000">,</font> fullKey<font color="#990000">:</font> fullHash<font color="#990000">.</font>key<font color="#990000">,</font> previewKey<font color="#990000">:</font> previewHash<font color="#990000">.</font>key<font color="#990000">,</font> fullStorePromise<font color="#990000">:</font> fullStorePromise<font color="#990000">,</font> previewStorePromise<font color="#990000">:</font> previewStorePromise <font color="#FF0000">}</font><font color="#990000">;</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">storeImage</font></b><font color="#990000">(</font>image<font color="#990000">,</font> image_id<font color="#990000">,</font> keyData<font color="#990000">,</font> type<font color="#990000">)</font> <font color="#FF0000">{</font>

    <b><font color="#0000FF">const</font></b> storeReqResp <font color="#990000">=</font> <b><font color="#000000">await</font></b> <font color="#990000">(</font>await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>STORAGE_SERVER <font color="#990000">+</font> <font color="#FF0000">"/storeRequest?name="</font> <font color="#990000">+</font> image_id<font color="#990000">)).</font><b><font color="#000000">arrayBuffer</font></b><font color="#990000">();</font>
    <b><font color="#0000FF">const</font></b> encrypt_data <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">extractPayload</font></b><font color="#990000">(</font>storeReqResp<font color="#990000">);</font>
    <i><font color="#9A1900">// console.log(encrypt_data)</font></i>
    <b><font color="#0000FF">const</font></b> key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getImageKey</font></b><font color="#990000">(</font>keyData<font color="#990000">,</font> encrypt_data<font color="#990000">.</font>salt<font color="#990000">);</font>
    let storageToken<font color="#990000">,</font> verificationToken<font color="#990000">;</font>
    <b><font color="#0000FF">const</font></b> data <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">encrypt</font></b><font color="#990000">(</font>image<font color="#990000">,</font> key<font color="#990000">,</font> <font color="#FF0000">"arrayBuffer"</font><font color="#990000">,</font> encrypt_data<font color="#990000">.</font>iv<font color="#990000">);</font>
    <i><font color="#9A1900">// console.log(data)</font></i>
    <b><font color="#0000FF">const</font></b> storageTokenReq <font color="#990000">=</font> <b><font color="#000000">await</font></b> <font color="#990000">(</font>await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>ROOM_SERVER <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">'/storageRequest?size='</font> <font color="#990000">+</font> data<font color="#990000">.</font>content<font color="#990000">.</font>byteLength<font color="#990000">)).</font><b><font color="#000000">json</font></b><font color="#990000">();</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>storageTokenReq<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">'error'</font><font color="#990000">))</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> storageTokenReq<font color="#990000">.</font>error <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    <i><font color="#9A1900">// storageToken = new TextEncoder().encode(storageTokenReq.token);</font></i>
    storageToken <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>storageTokenReq<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> resp <font color="#990000">=</font> await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>STORAGE_SERVER <font color="#990000">+</font> <font color="#FF0000">"/storeData?type="</font> <font color="#990000">+</font> type <font color="#990000">+</font> <font color="#FF0000">"&amp;key="</font> <font color="#990000">+</font> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>image_id<font color="#990000">),</font>
      <font color="#FF0000">{</font>
	method<font color="#990000">:</font> <font color="#FF0000">"POST"</font><font color="#990000">,</font>
	body<font color="#990000">:</font> utils<font color="#990000">.</font><b><font color="#000000">assemblePayload</font></b><font color="#990000">(</font><font color="#FF0000">{</font>
	  iv<font color="#990000">:</font> encrypt_data<font color="#990000">.</font>iv<font color="#990000">,</font>
	  salt<font color="#990000">:</font> encrypt_data<font color="#990000">.</font>salt<font color="#990000">,</font>
	  image<font color="#990000">:</font> data<font color="#990000">.</font>content<font color="#990000">,</font>
	  storageToken<font color="#990000">:</font> <font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">TextEncoder</font></b><font color="#990000">()).</font><b><font color="#000000">encode</font></b><font color="#990000">(</font>storageToken<font color="#990000">),</font>
	  vid<font color="#990000">:</font> window<font color="#990000">.</font>crypto<font color="#990000">.</font><b><font color="#000000">getRandomValues</font></b><font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font><font color="#993399">48</font><font color="#990000">))</font>
	<font color="#FF0000">}</font><font color="#990000">)</font>
      <font color="#FF0000">}</font><font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> resp_json <font color="#990000">=</font> await resp<font color="#990000">.</font><b><font color="#000000">json</font></b><font color="#990000">();</font>
    <i><font color="#9A1900">// console.log("Response for " + type + ": ", resp_json)</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>resp_json<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">'error'</font><font color="#990000">))</font> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// TODO - why can't we throw exceptions?</font></i>
      <i><font color="#9A1900">// Promise.reject(new Error('Server error on storing image (' + resp_json.error + ')'));</font></i>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Error: storeImage() failed ('</font> <font color="#990000">+</font> resp_json<font color="#990000">.</font>error <font color="#990000">+</font> <font color="#FF0000">')'</font> <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
    verificationToken <font color="#990000">=</font> resp_json<font color="#990000">.</font>verification_token<font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> verificationToken<font color="#990000">:</font> verificationToken<font color="#990000">,</font> id<font color="#990000">:</font> resp_json<font color="#990000">.</font>image_id<font color="#990000">,</font> type<font color="#990000">:</font> type <font color="#FF0000">}</font><font color="#990000">;</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">generateImageHash</font></b><font color="#990000">(</font>image<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> digest <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">digest</font></b><font color="#990000">(</font><font color="#FF0000">'SHA-512'</font><font color="#990000">,</font> image<font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> _id <font color="#990000">=</font> digest<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">32</font><font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> _key <font color="#990000">=</font> digest<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(</font><font color="#993399">32</font><font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font> id<font color="#990000">:</font> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>utils<font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>_id<font color="#990000">)),</font> key<font color="#990000">:</font> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>utils<font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>_key<font color="#990000">))</font> <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">retrieveImagePreview</font></b><font color="#990000">(</font>msgId<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> imageHash <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#990000">.</font><b><font color="#000000">find</font></b><font color="#990000">(</font>msg <font color="#990000">=&gt;</font> msg<font color="#990000">.</font>_id <font color="#990000">===</font> msgId<font color="#990000">).</font>imageMetaData<font color="#990000">;</font>
      <i><font color="#9A1900">// console.log(imageHash)</font></i>
      <b><font color="#0000FF">const</font></b> image_id <font color="#990000">=</font> imageHash<font color="#990000">.</font>previewId<font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> imageFetch <font color="#990000">=</font> <b><font color="#000000">await</font></b> <font color="#990000">(</font>await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>STORAGE_SERVER <font color="#990000">+</font> <font color="#FF0000">"/fetchImage?id="</font> <font color="#990000">+</font> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>image_id<font color="#990000">))).</font><b><font color="#000000">arrayBuffer</font></b><font color="#990000">();</font>
      <b><font color="#0000FF">const</font></b> data <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">extractPayload</font></b><font color="#990000">(</font>imageFetch<font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> iv <font color="#990000">=</font> data<font color="#990000">.</font>iv<font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> salt <font color="#990000">=</font> data<font color="#990000">.</font>salt<font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> image_key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getImageKey</font></b><font color="#990000">(</font>imageHash<font color="#990000">.</font>previewKey<font color="#990000">,</font> salt<font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> encrypted_image <font color="#990000">=</font> data<font color="#990000">.</font>image<font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> img <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">decrypt</font></b><font color="#990000">(</font>image_key<font color="#990000">,</font> <font color="#FF0000">{</font> content<font color="#990000">:</font> encrypted_image<font color="#990000">,</font> iv<font color="#990000">:</font> iv <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">"arrayBuffer"</font><font color="#990000">);</font>
      <i><font color="#9A1900">//console.log(img)</font></i>
      <i><font color="#9A1900">//console.log("data:image/jpeg;base64,"+this.arrayBufferToBase64(img.plaintext))</font></i>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>img<font color="#990000">.</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <font color="#FF0000">"data:image/jpeg;base64,"</font> <font color="#990000">+</font> utils<font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>img<font color="#990000">.</font>plaintext<font color="#990000">);</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">retrieveData</font></b><font color="#990000">(</font>msgId<font color="#990000">)</font> <font color="#FF0000">{</font>
    <i><font color="#9A1900">// console.log(this.state.controlMessages)</font></i>
    <b><font color="#0000FF">const</font></b> imageMetaData <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#990000">.</font><b><font color="#000000">find</font></b><font color="#990000">(</font>msg <font color="#990000">=&gt;</font> msg<font color="#990000">.</font>_id <font color="#990000">===</font> msgId<font color="#990000">).</font>imageMetaData<font color="#990000">;</font>
    <i><font color="#9A1900">// console.log(imageHash)</font></i>
    <b><font color="#0000FF">const</font></b> image_id <font color="#990000">=</font> imageMetaData<font color="#990000">.</font>previewId<font color="#990000">;</font>
    <b><font color="#0000FF">const</font></b> control_msg <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>controlMessages<font color="#990000">.</font><b><font color="#000000">find</font></b><font color="#990000">(</font>msg <font color="#990000">=&gt;</font> msg<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">'id'</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> msg<font color="#990000">.</font>id<font color="#990000">.</font><b><font color="#000000">startsWith</font></b><font color="#990000">(</font>image_id<font color="#990000">));</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>imageMetaData<font color="#990000">,</font> image_id<font color="#990000">,</font> control_msg<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>controlMessages<font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>control_msg<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font><font color="#FF0000">'error'</font><font color="#990000">:</font> <font color="#FF0000">'Failed to fetch data - missing control message for that image'</font><font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">const</font></b> imageFetch <font color="#990000">=</font> <b><font color="#000000">await</font></b> <font color="#990000">(</font>await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>STORAGE_SERVER <font color="#990000">+</font> <font color="#FF0000">"/fetchData?id="</font> <font color="#990000">+</font> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>control_msg<font color="#990000">.</font>id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">'&amp;verification_token='</font> <font color="#990000">+</font> control_msg<font color="#990000">.</font>verificationToken<font color="#990000">)).</font><b><font color="#000000">arrayBuffer</font></b><font color="#990000">();</font>
    <b><font color="#0000FF">const</font></b> data <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">extractPayload</font></b><font color="#990000">(</font>imageFetch<font color="#990000">);</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>data<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> iv <font color="#990000">=</font> data<font color="#990000">.</font>iv<font color="#990000">;</font>
    <b><font color="#0000FF">const</font></b> salt <font color="#990000">=</font> data<font color="#990000">.</font>salt<font color="#990000">;</font>
    <b><font color="#0000FF">const</font></b> image_key <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getImageKey</font></b><font color="#990000">(</font>imageMetaData<font color="#990000">.</font>previewKey<font color="#990000">,</font> salt<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> encrypted_image <font color="#990000">=</font> data<font color="#990000">.</font>image<font color="#990000">;</font>
    <b><font color="#0000FF">const</font></b> padded_img <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">decrypt</font></b><font color="#990000">(</font>image_key<font color="#990000">,</font> <font color="#FF0000">{</font> content<font color="#990000">:</font> encrypted_image<font color="#990000">,</font> iv<font color="#990000">:</font> iv <font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">"arrayBuffer"</font><font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> img <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">unpadData</font></b><font color="#990000">(</font>padded_img<font color="#990000">.</font>plaintext<font color="#990000">);</font>
    <i><font color="#9A1900">//console.log(img)</font></i>
    <i><font color="#9A1900">//console.log("data:image/jpeg;base64,"+this.arrayBufferToBase64(img.plaintext))</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>img<font color="#990000">.</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">'(Image error: '</font> <font color="#990000">+</font> img<font color="#990000">.</font>error <font color="#990000">+</font> <font color="#FF0000">')'</font><font color="#990000">);</font>
      <b><font color="#0000FF">throw</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">'Failed to fetch data - authentication or formatting error'</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font><font color="#FF0000">'url'</font> <font color="#990000">:</font> <font color="#FF0000">"data:image/jpeg;base64,"</font> <font color="#990000">+</font> utils<font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>img<font color="#990000">)</font> <font color="#FF0000">}</font><font color="#990000">;</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">getFileData</font></b><font color="#990000">(</font>file<font color="#990000">,</font> outputType<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      let reader <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">FileReader</font></b><font color="#990000">();</font>
      <b><font color="#0000FF">if</font></b><font color="#990000">(</font>file<font color="#990000">.</font>size <font color="#990000">===</font> <font color="#993399">0</font><font color="#990000">)</font><font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
      <font color="#FF0000">}</font>
      outputType <font color="#990000">===</font> <font color="#FF0000">'url'</font> <font color="#990000">?</font> reader<font color="#990000">.</font><b><font color="#000000">readAsDataURL</font></b><font color="#990000">(</font>file<font color="#990000">)</font> <font color="#990000">:</font> reader<font color="#990000">.</font><b><font color="#000000">readAsArrayBuffer</font></b><font color="#990000">(</font>file<font color="#990000">);</font>
      let promise <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Promise</font></b><font color="#990000">((</font>resolve<font color="#990000">,</font> reject<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
        reader<font color="#990000">.</font>onloadend <font color="#990000">=</font> <font color="#990000">(</font>event<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
          let the_blob <font color="#990000">=</font> reader<font color="#990000">.</font>result<font color="#990000">;</font>
          <b><font color="#000000">resolve</font></b><font color="#990000">(</font>the_blob<font color="#990000">);</font>
        <font color="#FF0000">}</font><font color="#990000">;</font>
      <font color="#FF0000">}</font><font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> promise<font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">restrictPhoto</font></b><font color="#990000">(</font>photo<font color="#990000">,</font> maxSize<font color="#990000">,</font> imageType<font color="#990000">,</font> qualityArgument<font color="#990000">)</font> <font color="#FF0000">{</font>
    <i><font color="#9A1900">// imageType default should be 'image/jpeg'</font></i>
    <i><font color="#9A1900">// qualityArgument should be 0.92 for jpeg and 0.8 for png (MDN default)</font></i>
    maxSize <font color="#990000">=</font> maxSize <font color="#990000">*</font> <font color="#993399">1024</font><font color="#990000">;</font> <i><font color="#9A1900">// KB</font></i>
    <i><font color="#9A1900">// console.log(`Target size is ${maxSize} bytes`);</font></i>
    let _c <font color="#990000">=</font> await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">readPhoto</font></b><font color="#990000">(</font>photo<font color="#990000">);</font>
    <b><font color="#0000FF">var</font></b> _b1 <font color="#990000">=</font> await <b><font color="#0000FF">new</font></b> <b><font color="#000000">Promise</font></b><font color="#990000">((</font>resolve<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
      _c<font color="#990000">.</font><b><font color="#000000">toBlob</font></b><font color="#990000">(</font>resolve<font color="#990000">,</font> imageType<font color="#990000">,</font> qualityArgument<font color="#990000">);</font>
    <font color="#FF0000">}</font><font color="#990000">);</font>
    <i><font color="#9A1900">// workingDots();</font></i>
    <i><font color="#9A1900">// console.log(`start canvas W ${_c.width} x H ${_c.height}`)</font></i>
    let _size <font color="#990000">=</font> _b1<font color="#990000">.</font>size<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>_size <font color="#990000">&lt;=</font> maxSize<font color="#990000">)</font> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// console.log(`Starting size ${_size} is fine`);</font></i>
      <b><font color="#0000FF">return</font></b> _b1<font color="#990000">;</font>
    <font color="#FF0000">}</font>
    <i><font color="#9A1900">// console.log(`Starting size ${_size} too large, start by reducing image size`);</font></i>
    <i><font color="#9A1900">// compression wasn't enough, so let's resize until we're getting close</font></i>
    let _old_size<font color="#990000">;</font>
    let _old_c<font color="#990000">;</font>
    <b><font color="#0000FF">while</font></b> <font color="#990000">(</font>_size <font color="#990000">&gt;</font> maxSize<font color="#990000">)</font> <font color="#FF0000">{</font>
      _old_c <font color="#990000">=</font> _c<font color="#990000">;</font>
      _c <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">scaleCanvas</font></b><font color="#990000">(</font>_c<font color="#990000">,</font> <font color="#990000">.</font><font color="#993399">5</font><font color="#990000">);</font>
      _b1 <font color="#990000">=</font> await <b><font color="#0000FF">new</font></b> <b><font color="#000000">Promise</font></b><font color="#990000">((</font>resolve<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
        _c<font color="#990000">.</font><b><font color="#000000">toBlob</font></b><font color="#990000">(</font>resolve<font color="#990000">,</font> imageType<font color="#990000">,</font> qualityArgument<font color="#990000">);</font>
      <font color="#FF0000">}</font><font color="#990000">);</font>
      _old_size <font color="#990000">=</font> _size<font color="#990000">;</font>
      _size <font color="#990000">=</font> _b1<font color="#990000">.</font>size<font color="#990000">;</font>
      <i><font color="#9A1900">// workingDots();</font></i>
      <i><font color="#9A1900">// console.log(`... reduced to W ${_c.width} x H ${_c.height} (to size ${_size})`);</font></i>
    <font color="#FF0000">}</font>

    <i><font color="#9A1900">// we assume that within this width interval, storage is roughly prop to area,</font></i>
    <i><font color="#9A1900">// with a little tuning downards</font></i>
    let _ratio <font color="#990000">=</font> maxSize <font color="#990000">/</font> _old_size<font color="#990000">;</font>
    let _maxIteration <font color="#990000">=</font> <font color="#993399">12</font><font color="#990000">;</font>  <i><font color="#9A1900">// to be safe</font></i>
    <i><font color="#9A1900">// console.log(`... stepping back up to W ${_old_c.width} x H ${_old_c.height} and will then try scale ${_ratio.toFixed(4)}`);</font></i>
    let _final_c<font color="#990000">;</font>
    <b><font color="#0000FF">do</font></b> <font color="#FF0000">{</font>
      _final_c <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">scaleCanvas</font></b><font color="#990000">(</font>_old_c<font color="#990000">,</font> Math<font color="#990000">.</font><b><font color="#000000">sqrt</font></b><font color="#990000">(</font>_ratio<font color="#990000">)</font> <font color="#990000">*</font> <font color="#993399">0.99</font><font color="#990000">);</font>  <i><font color="#9A1900">// we're targeting within 1%</font></i>
      _b1 <font color="#990000">=</font> await <b><font color="#0000FF">new</font></b> <b><font color="#000000">Promise</font></b><font color="#990000">((</font>resolve<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
        _final_c<font color="#990000">.</font><b><font color="#000000">toBlob</font></b><font color="#990000">(</font>resolve<font color="#990000">,</font> imageType<font color="#990000">,</font> qualityArgument<font color="#990000">);</font>
        <i><font color="#9A1900">// console.log(`(generating blob of requested type ${imageType})`);</font></i>
      <font color="#FF0000">}</font><font color="#990000">);</font>
      <i><font color="#9A1900">// workingDots();</font></i>
      <i><font color="#9A1900">// console.log(`... fine-tuning to W ${_final_c.width} x H ${_final_c.height} (size ${_b1.size})`);</font></i>
      _ratio <font color="#990000">*=</font> <font color="#990000">(</font>maxSize <font color="#990000">/</font> _b1<font color="#990000">.</font>size<font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">while</font></b> <font color="#990000">(((</font>_b1<font color="#990000">.</font>size <font color="#990000">&gt;</font> maxSize<font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">((</font>Math<font color="#990000">.</font><b><font color="#000000">abs</font></b><font color="#990000">(</font>_b1<font color="#990000">.</font>size <font color="#990000">-</font> maxSize<font color="#990000">)</font> <font color="#990000">/</font> maxSize<font color="#990000">)</font> <font color="#990000">&gt;</font> <font color="#993399">0.02</font><font color="#990000">))</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(--</font>_maxIteration <font color="#990000">&gt;</font> <font color="#993399">0</font><font color="#990000">));</font>  <i><font color="#9A1900">// it's ok within 2%</font></i>

    <i><font color="#9A1900">// workingDots();</font></i>
    <i><font color="#9A1900">// console.log(`... ok looks like we're good now ... final size is ${_b1.size} (which is ${((_b1.size * 100) / maxSize).toFixed(2)}% of cap)`);</font></i>

    <i><font color="#9A1900">// document.getElementById('the-original-image').width = _final_c.width;  // a bit of a hack</font></i>
    <b><font color="#0000FF">return</font></b> _b1<font color="#990000">;</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">readPhoto</font></b><font color="#990000">(</font>photo<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> canvas <font color="#990000">=</font> document<font color="#990000">.</font><b><font color="#000000">createElement</font></b><font color="#990000">(</font><font color="#FF0000">'canvas'</font><font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> img <font color="#990000">=</font> document<font color="#990000">.</font><b><font color="#000000">createElement</font></b><font color="#990000">(</font><font color="#FF0000">'img'</font><font color="#990000">);</font>

    <i><font color="#9A1900">// create img element from File object</font></i>
    img<font color="#990000">.</font>src <font color="#990000">=</font> await <b><font color="#0000FF">new</font></b> <b><font color="#000000">Promise</font></b><font color="#990000">((</font>resolve<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> reader <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">FileReader</font></b><font color="#990000">();</font>
      reader<font color="#990000">.</font>onload <font color="#990000">=</font> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#990000">=&gt;</font> <b><font color="#000000">resolve</font></b><font color="#990000">(</font>e<font color="#990000">.</font>target<font color="#990000">.</font>result<font color="#990000">);</font>
      reader<font color="#990000">.</font><b><font color="#000000">readAsDataURL</font></b><font color="#990000">(</font>photo<font color="#990000">);</font>
    <font color="#FF0000">}</font><font color="#990000">);</font>
    await <b><font color="#0000FF">new</font></b> <b><font color="#000000">Promise</font></b><font color="#990000">((</font>resolve<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
      img<font color="#990000">.</font>onload <font color="#990000">=</font> resolve<font color="#990000">;</font>
    <font color="#FF0000">}</font><font color="#990000">);</font>

    <i><font color="#9A1900">// console.log("img object");</font></i>
    <i><font color="#9A1900">// console.log(img);</font></i>
    <i><font color="#9A1900">// console.log("canvas object");</font></i>
    <i><font color="#9A1900">// console.log(canvas);</font></i>

    <i><font color="#9A1900">// draw image in canvas element</font></i>
    canvas<font color="#990000">.</font>width <font color="#990000">=</font> img<font color="#990000">.</font>width<font color="#990000">;</font>
    canvas<font color="#990000">.</font>height <font color="#990000">=</font> img<font color="#990000">.</font>height<font color="#990000">;</font>
    canvas<font color="#990000">.</font><b><font color="#000000">getContext</font></b><font color="#990000">(</font><font color="#FF0000">'2d'</font><font color="#990000">).</font><b><font color="#000000">drawImage</font></b><font color="#990000">(</font>img<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> canvas<font color="#990000">.</font>width<font color="#990000">,</font> canvas<font color="#990000">.</font>height<font color="#990000">);</font>
    <b><font color="#0000FF">return</font></b> canvas<font color="#990000">;</font>
  <font color="#FF0000">}</font><font color="#990000">;</font>


  <b><font color="#000000">scaleCanvas</font></b><font color="#990000">(</font>canvas<font color="#990000">,</font> scale<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> scaledCanvas <font color="#990000">=</font> document<font color="#990000">.</font><b><font color="#000000">createElement</font></b><font color="#990000">(</font><font color="#FF0000">'canvas'</font><font color="#990000">);</font>
    scaledCanvas<font color="#990000">.</font>width <font color="#990000">=</font> canvas<font color="#990000">.</font>width <font color="#990000">*</font> scale<font color="#990000">;</font>
    scaledCanvas<font color="#990000">.</font>height <font color="#990000">=</font> canvas<font color="#990000">.</font>height <font color="#990000">*</font> scale<font color="#990000">;</font>
    <i><font color="#9A1900">// console.log(`#### scaledCanvas target W ${scaledCanvas.width} x H ${scaledCanvas.height}`);</font></i>
    scaledCanvas
      <font color="#990000">.</font><b><font color="#000000">getContext</font></b><font color="#990000">(</font><font color="#FF0000">'2d'</font><font color="#990000">)</font>
      <font color="#990000">.</font><b><font color="#000000">drawImage</font></b><font color="#990000">(</font>canvas<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> scaledCanvas<font color="#990000">.</font>width<font color="#990000">,</font> scaledCanvas<font color="#990000">.</font>height<font color="#990000">);</font>
    <i><font color="#9A1900">// console.log(`#### scaledCanvas actual W ${scaledCanvas.width} x H ${scaledCanvas.height}`);</font></i>
    <b><font color="#0000FF">return</font></b> scaledCanvas<font color="#990000">;</font>
  <font color="#FF0000">}</font><font color="#990000">;</font>


  <b><font color="#000000">padImage</font></b><font color="#990000">(</font>image_buffer<font color="#990000">)</font> <font color="#FF0000">{</font>
    let _sizes <font color="#990000">=</font> <font color="#990000">[</font><font color="#993399">128</font><font color="#990000">,</font> <font color="#993399">256</font><font color="#990000">,</font> <font color="#993399">512</font><font color="#990000">,</font> <font color="#993399">1024</font><font color="#990000">,</font> <font color="#993399">2048</font><font color="#990000">,</font> <font color="#993399">4096</font><font color="#990000">];</font>   <i><font color="#9A1900">// in KB</font></i>
    _sizes <font color="#990000">=</font> _sizes<font color="#990000">.</font><b><font color="#000000">map</font></b><font color="#990000">((</font>size<font color="#990000">)</font> <font color="#990000">=&gt;</font> size <font color="#990000">*</font> <font color="#993399">1024</font><font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> image_size <font color="#990000">=</font> image_buffer<font color="#990000">.</font>byteLength<font color="#990000">;</font>
    <i><font color="#9A1900">// console.log('BEFORE PADDING: ', image_size)</font></i>
    let _target<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>image_size <font color="#990000">&lt;</font> _sizes<font color="#990000">[</font>_sizes<font color="#990000">.</font>length <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">])</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> _sizes<font color="#990000">.</font>length<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>image_size <font color="#990000">+</font> <font color="#993399">21</font> <font color="#990000">&lt;</font> _sizes<font color="#990000">[</font>i<font color="#990000">])</font> <font color="#FF0000">{</font>
          _target <font color="#990000">=</font> _sizes<font color="#990000">[</font>i<font color="#990000">];</font>
          <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
      _target <font color="#990000">=</font> <font color="#990000">(</font>Math<font color="#990000">.</font><b><font color="#000000">ceil</font></b><font color="#990000">(</font>image_size <font color="#990000">/</font> <font color="#990000">(</font><font color="#993399">1024</font> <font color="#990000">*</font> <font color="#993399">1024</font><font color="#990000">)))</font> <font color="#990000">*</font> <font color="#993399">1024</font> <font color="#990000">*</font> <font color="#993399">1024</font><font color="#990000">;</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>image_size <font color="#990000">+</font> <font color="#993399">21</font> <font color="#990000">&gt;=</font> _target<font color="#990000">)</font> <font color="#FF0000">{</font>
        _target <font color="#990000">+=</font> <font color="#993399">1024</font><font color="#990000">;</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    let _padding_array <font color="#990000">=</font> <font color="#990000">[</font><font color="#993399">128</font><font color="#990000">];</font>
    _target <font color="#990000">=</font> _target <font color="#990000">-</font> image_size <font color="#990000">-</font> <font color="#993399">21</font><font color="#990000">;</font>
    <i><font color="#9A1900">// We will finally convert to Uint32Array where each element is 4 bytes</font></i>
    <i><font color="#9A1900">// So we need (_target/4) - 6 array elements with value 0 (128 bits or 16 bytes or 4 elements to be left empty,</font></i>
    <i><font color="#9A1900">// last 4 bytes or 1 element to represent the size and 1st element is 128 or 0x80)</font></i>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> _target<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
      _padding_array<font color="#990000">.</font><b><font color="#000000">push</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <i><font color="#9A1900">// _padding_array.push(image_size);</font></i>
    <b><font color="#0000FF">const</font></b> _padding <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font>_padding_array<font color="#990000">).</font>buffer<font color="#990000">;</font>
    <i><font color="#9A1900">// console.log('Padding size: ', _padding.byteLength)</font></i>
    let final_data <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">_appendBuffer</font></b><font color="#990000">(</font>image_buffer<font color="#990000">,</font> _padding<font color="#990000">);</font>
    final_data <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">_appendBuffer</font></b><font color="#990000">(</font>final_data<font color="#990000">,</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint32Array</font></b><font color="#990000">([</font>image_size<font color="#990000">]).</font>buffer<font color="#990000">);</font>
    <i><font color="#9A1900">// console.log('AFTER PADDING: ', final_data.byteLength)</font></i>
    <b><font color="#0000FF">return</font></b> final_data<font color="#990000">;</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">unpadData</font></b><font color="#990000">(</font>data_buffer<font color="#990000">)</font> <font color="#FF0000">{</font>
    <i><font color="#9A1900">// console.log(data_buffer, typeof data_buffer)</font></i>
    <b><font color="#0000FF">const</font></b> _size <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint32Array</font></b><font color="#990000">(</font>data_buffer<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(-</font><font color="#993399">4</font><font color="#990000">))[</font><font color="#993399">0</font><font color="#990000">];</font>
    <b><font color="#0000FF">return</font></b> data_buffer<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> _size<font color="#990000">);</font>
  <font color="#FF0000">}</font>


  <i><font color="#9A1900">// #######################    FUNCTIONS TO MANIPULATE UI/FOR GIFTED-CHAT    #################################</font></i>

  <i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900">  renderBubble() is a custom function to style messages.</font></i>
<i><font color="#9A1900">  </font></i><b>TODO</b><i><font color="#9A1900"> - Have all styles in a separate file and import here to make it easier to experiment and make changes</font></i>
<i><font color="#9A1900">  */</font></i>

  <b><font color="#000000">renderBubble</font></b><font color="#990000">(</font>props<font color="#990000">)</font> <font color="#FF0000">{</font>
    let newProps <font color="#990000">=</font> <font color="#FF0000">{}</font>
    let current_user_key<font color="#990000">;</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      current_user_key <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>props<font color="#990000">.</font>currentMessage<font color="#990000">.</font>user<font color="#990000">.</font>_id<font color="#990000">);</font>
      <i><font color="#9A1900">//newProps.position = this.state.contacts[current_user_key.x + ' ' + current_user_key.y] === 'Me' ? 'right' : 'left';</font></i>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// onsole.log(props.currentMessage.user._id)</font></i>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>props<font color="#990000">.</font>currentMessage<font color="#990000">.</font>whispered<font color="#990000">)</font> <font color="#FF0000">{</font>
        newProps <font color="#990000">=</font> <font color="#FF0000">{</font>
          wrapperStyle<font color="#990000">:</font> <font color="#FF0000">{</font>
            left<font color="#990000">:</font> <font color="#FF0000">{</font>
              backgroundColor<font color="#990000">:</font> <font color="#FF0000">"yellow"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font><font color="#990000">,</font>
            right<font color="#990000">:</font> <font color="#FF0000">{</font>
              backgroundColor<font color="#990000">:</font> <font color="#FF0000">"yellow"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font>
          <font color="#FF0000">}</font><font color="#990000">,</font>
          textStyle<font color="#990000">:</font> <font color="#FF0000">{</font>
            left<font color="#990000">:</font> <font color="#FF0000">{</font>
              fontStyle<font color="#990000">:</font> <font color="#FF0000">"italic"</font><font color="#990000">,</font>
              color<font color="#990000">:</font> <font color="#FF0000">"Black"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font><font color="#990000">,</font>
            right<font color="#990000">:</font> <font color="#FF0000">{</font>
              fontStyle<font color="#990000">:</font> <font color="#FF0000">"italic"</font><font color="#990000">,</font>
              color<font color="#990000">:</font> <font color="#FF0000">"black"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font>
          <font color="#FF0000">}</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>props<font color="#990000">.</font>currentMessage<font color="#990000">.</font>verified <font color="#990000">===</font> <b><font color="#0000FF">false</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
        newProps <font color="#990000">=</font> <font color="#FF0000">{</font>
          wrapperStyle<font color="#990000">:</font> <font color="#FF0000">{</font>
            left<font color="#990000">:</font> <font color="#FF0000">{</font>
              borderColor<font color="#990000">:</font> <font color="#FF0000">"red"</font><font color="#990000">,</font>
              borderStyle<font color="#990000">:</font> <font color="#FF0000">"solid"</font><font color="#990000">,</font>
              borderWidth<font color="#990000">:</font> <font color="#FF0000">"4px"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font><font color="#990000">,</font>
            right<font color="#990000">:</font> <font color="#FF0000">{</font>
              borderColor<font color="#990000">:</font> <font color="#FF0000">"red"</font><font color="#990000">,</font>
              borderStyle<font color="#990000">:</font> <font color="#FF0000">"solid"</font><font color="#990000">,</font>
              borderWidth<font color="#990000">:</font> <font color="#FF0000">"4px"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font>
          <font color="#FF0000">}</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>props<font color="#990000">.</font>currentMessage<font color="#990000">.</font>info<font color="#990000">)</font> <font color="#FF0000">{</font>
        newProps <font color="#990000">=</font> <font color="#FF0000">{</font>
          wrapperStyle<font color="#990000">:</font> <font color="#FF0000">{</font>
            left<font color="#990000">:</font> <font color="#FF0000">{</font>
              borderColor<font color="#990000">:</font> <font color="#FF0000">"black"</font><font color="#990000">,</font>
              borderStyle<font color="#990000">:</font> <font color="#FF0000">"solid"</font><font color="#990000">,</font>
              borderWidth<font color="#990000">:</font> <font color="#FF0000">"2px"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font>
          <font color="#FF0000">}</font><font color="#990000">,</font>
          textStyle<font color="#990000">:</font> <font color="#FF0000">{</font>
            left<font color="#990000">:</font> <font color="#FF0000">{</font>
              fontStyle<font color="#990000">:</font> <font color="#FF0000">"italic"</font><font color="#990000">,</font>
              color<font color="#990000">:</font> <font color="#FF0000">"Black"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font><font color="#990000">,</font>
          <font color="#FF0000">}</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
      <i><font color="#9A1900">// else if (props.currentMessage.user._id === JSON.stringify(this.state.keys.exportable_room_pubKey)) {</font></i>
      <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">areKeysSame</font></b><font color="#990000">(</font>current_user_key<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_owner_pubKey<font color="#990000">))</font> <font color="#FF0000">{</font>
        newProps <font color="#990000">=</font> <font color="#FF0000">{</font>
          wrapperStyle<font color="#990000">:</font> <font color="#FF0000">{</font>
            left<font color="#990000">:</font> <font color="#FF0000">{</font>
              borderColor<font color="#990000">:</font> <font color="#FF0000">"#2ECC40"</font><font color="#990000">,</font>
              borderStyle<font color="#990000">:</font> <font color="#FF0000">"solid"</font><font color="#990000">,</font>
              borderWidth<font color="#990000">:</font> <font color="#FF0000">"4px"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font><font color="#990000">,</font>
            right<font color="#990000">:</font> <font color="#FF0000">{</font>
              borderColor<font color="#990000">:</font> <font color="#FF0000">"#2ECC40"</font><font color="#990000">,</font>
              borderStyle<font color="#990000">:</font> <font color="#FF0000">"solid"</font><font color="#990000">,</font>
              borderWidth<font color="#990000">:</font> <font color="#FF0000">"4px"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font>
          <font color="#FF0000">}</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
      <i><font color="#9A1900">//else if (props.currentMessage.user._id === JSON.stringify(this.state.keys.exportable_verifiedGuest_pubKey)) {</font></i>
      <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">areKeysSame</font></b><font color="#990000">(</font>current_user_key<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_verifiedGuest_pubKey<font color="#990000">))</font> <font color="#FF0000">{</font>
        newProps <font color="#990000">=</font> <font color="#FF0000">{</font>
          wrapperStyle<font color="#990000">:</font> <font color="#FF0000">{</font>
            left<font color="#990000">:</font> <font color="#FF0000">{</font>
              borderColor<font color="#990000">:</font> <font color="#FF0000">"#B10DC9"</font><font color="#990000">,</font>
              borderStyle<font color="#990000">:</font> <font color="#FF0000">"solid"</font><font color="#990000">,</font>
              borderWidth<font color="#990000">:</font> <font color="#FF0000">"4px"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font><font color="#990000">,</font>
            right<font color="#990000">:</font> <font color="#FF0000">{</font>
              borderColor<font color="#990000">:</font> <font color="#FF0000">"#B10DC9"</font><font color="#990000">,</font>
              borderStyle<font color="#990000">:</font> <font color="#FF0000">"solid"</font><font color="#990000">,</font>
              borderWidth<font color="#990000">:</font> <font color="#FF0000">"4px"</font><font color="#990000">,</font>
            <font color="#FF0000">}</font>
          <font color="#FF0000">}</font>
        <font color="#FF0000">}</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <i><font color="#9A1900">// For username on top</font></i>
    <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>
      <font color="#990000">&lt;</font>View style<font color="#990000">=</font><font color="#FF0000">{{</font> width<font color="#990000">:</font> <font color="#FF0000">'90%'</font> <font color="#FF0000">}}</font><font color="#990000">&gt;</font>
        <font color="#FF0000">{</font><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">isSameUser</font></b><font color="#990000">(</font>props<font color="#990000">.</font>currentMessage<font color="#990000">,</font> props<font color="#990000">.</font>previousMessage<font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">isSameDay</font></b><font color="#990000">(</font>props<font color="#990000">.</font>currentMessage<font color="#990000">,</font> props<font color="#990000">.</font>previousMessage<font color="#990000">))</font> <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">areKeysSame</font></b><font color="#990000">(</font>current_user_key<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">)</font> <font color="#990000">?</font> <b><font color="#0000FF">null</font></b> <font color="#990000">:</font> <font color="#990000">&lt;</font>Text numberOfLines<font color="#990000">=</font><font color="#FF0000">{</font><font color="#993399">1</font><font color="#FF0000">}</font> style<font color="#990000">=</font><font color="#FF0000">{{</font> width<font color="#990000">:</font> <font color="#FF0000">'50vw'</font><font color="#990000">,</font> paddingBottom<font color="#990000">:</font> <font color="#993399">3</font><font color="#990000">,</font> left<font color="#990000">:</font> <font color="#993399">0</font><font color="#990000">,</font> fontSize<font color="#990000">:</font> <font color="#993399">12</font><font color="#990000">,</font> backgroundColor<font color="#990000">:</font> <font color="#FF0000">'transparent'</font><font color="#990000">,</font> color<font color="#990000">:</font> <font color="#FF0000">'#aaa'</font> <font color="#FF0000">}}</font><font color="#990000">&gt;</font><font color="#FF0000">{</font>props<font color="#990000">.</font>currentMessage<font color="#990000">.</font>user<font color="#990000">.</font>name<font color="#FF0000">}</font><font color="#990000">&lt;/</font>Text<font color="#990000">&gt;</font><font color="#FF0000">}</font>
        <font color="#990000">&lt;</font>Bubble
          <font color="#FF0000">{</font><font color="#990000">...</font>props<font color="#FF0000">}</font>
          <font color="#FF0000">{</font><font color="#990000">...</font>newProps<font color="#FF0000">}</font> <font color="#990000">/&gt;</font>
      <font color="#990000">&lt;/</font>View <font color="#990000">&gt;</font>
    <font color="#990000">)</font>
    <i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900">    return (</font></i>
<i><font color="#9A1900">      &lt;Bubble</font></i>
<i><font color="#9A1900">        {...props}</font></i>
<i><font color="#9A1900">        {...newProps} /&gt;</font></i>
<i><font color="#9A1900">    )</font></i>
<i><font color="#9A1900">    */</font></i>
  <font color="#FF0000">}</font>


  <i><font color="#9A1900">// Only needed for username on top</font></i>
  <b><font color="#000000">isSameUser</font></b><font color="#990000">(</font>currentMessage<font color="#990000">,</font> diffMessage<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>diffMessage <font color="#990000">&amp;&amp;</font>
      diffMessage<font color="#990000">.</font>user <font color="#990000">&amp;&amp;</font>
      currentMessage <font color="#990000">&amp;&amp;</font>
      currentMessage<font color="#990000">.</font>user <font color="#990000">&amp;&amp;</font>
      diffMessage<font color="#990000">.</font>user<font color="#990000">.</font>_id <font color="#990000">===</font> currentMessage<font color="#990000">.</font>user<font color="#990000">.</font>_id<font color="#990000">);</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">isSameDay</font></b><font color="#990000">(</font>currentMessage<font color="#990000">,</font> diffMessage<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>currentMessage <font color="#990000">||</font> <font color="#990000">!</font>diffMessage <font color="#990000">||</font> <font color="#990000">(!</font>currentMessage<font color="#990000">.</font>createdAt <font color="#990000">&amp;&amp;</font> <font color="#990000">!</font>diffMessage<font color="#990000">.</font>createdAt<font color="#990000">))</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>
    let currDt <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Date</font></b><font color="#990000">(</font>currentMessage<font color="#990000">.</font>createdAt<font color="#990000">);</font>
    let diffDt <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Date</font></b><font color="#990000">(</font>diffMessage<font color="#990000">.</font>createdAt<font color="#990000">);</font>
    <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>currDt<font color="#990000">.</font><b><font color="#000000">getDate</font></b><font color="#990000">()</font> <font color="#990000">-</font> diffDt<font color="#990000">.</font><b><font color="#000000">getDate</font></b><font color="#990000">()</font> <font color="#990000">===</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>currDt<font color="#990000">.</font><b><font color="#000000">getMonth</font></b><font color="#990000">()</font> <font color="#990000">-</font> diffDt<font color="#990000">.</font><b><font color="#000000">getMonth</font></b><font color="#990000">()</font> <font color="#990000">===</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>currDt<font color="#990000">.</font><b><font color="#000000">getFullYear</font></b><font color="#990000">()</font> <font color="#990000">-</font> diffDt<font color="#990000">.</font><b><font color="#000000">getFullYear</font></b><font color="#990000">()</font> <font color="#990000">===</font> <font color="#993399">0</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">promptUsername</font></b><font color="#990000">(</font>user<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> userId <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>user<font color="#990000">.</font>_id<font color="#990000">);</font>
      JwModal<font color="#990000">.</font><b><font color="#000000">open</font></b><font color="#990000">(</font><font color="#FF0000">'change-username'</font><font color="#990000">);</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> changeUsername<font color="#990000">:</font> <font color="#FF0000">{</font> _id<font color="#990000">:</font> user<font color="#990000">.</font>_id<font color="#990000">,</font> name<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>contacts<font color="#990000">[</font>userId<font color="#990000">.</font>x <font color="#990000">+</font> <font color="#FF0000">' '</font> <font color="#990000">+</font> userId<font color="#990000">.</font>y<font color="#990000">]</font> <font color="#FF0000">}</font> <font color="#FF0000">}</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">renderAttachmentIcon</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <font color="#990000">(&lt;</font>div<font color="#990000">&gt;</font>
        <font color="#990000">&lt;</font>div style<font color="#990000">=</font><font color="#FF0000">{{</font> height<font color="#990000">:</font> <font color="#FF0000">'0px'</font><font color="#990000">,</font> width<font color="#990000">:</font> <font color="#FF0000">'0px'</font><font color="#990000">,</font> overflow<font color="#990000">:</font> <font color="#FF0000">'hidden'</font> <font color="#FF0000">}}</font><font color="#990000">&gt;</font>
          <font color="#990000">&lt;</font>input type<font color="#990000">=</font><font color="#FF0000">"file"</font> id<font color="#990000">=</font><font color="#FF0000">"fileInput"</font> name<font color="#990000">=</font><font color="#FF0000">"file-input"</font> onChange<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>event<font color="#990000">)</font> <font color="#990000">=&gt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">previewImage</font></b><font color="#990000">(</font>event<font color="#990000">.</font>target<font color="#990000">.</font>files<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">])</font><font color="#FF0000">}</font> <font color="#990000">/&gt;</font>
        <font color="#990000">&lt;/</font>div<font color="#990000">&gt;</font>
        <font color="#990000">&lt;</font>img id<font color="#990000">=</font><font color="#FF0000">'attachment-icon'</font> src<font color="#990000">=</font><font color="#FF0000">{</font>attach_img<font color="#FF0000">}</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">()</font> <font color="#990000">=&gt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">chooseFile</font></b><font color="#990000">()</font><font color="#FF0000">}</font> alt<font color="#990000">=</font><font color="#FF0000">'Attchment Icon'</font><font color="#990000">&gt;&lt;</font><font color="#FF6600">/img&gt;&lt;/</font>div<font color="#990000">&gt;)</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">renderImage</font></b><font color="#990000">(</font>imageProps<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#0000FF">typeof</font></b> imageProps<font color="#990000">.</font>currentMessage<font color="#990000">.</font>image <font color="#990000">===</font> <font color="#FF0000">'string'</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <font color="#990000">&lt;</font>View<font color="#990000">&gt;&lt;</font>img className<font color="#990000">=</font><font color="#FF0000">'msgImg'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">()</font> <font color="#990000">=&gt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">openPreview</font></b><font color="#990000">(</font>imageProps<font color="#990000">.</font>currentMessage<font color="#990000">.</font>_id<font color="#990000">)</font><font color="#FF0000">}</font> src<font color="#990000">=</font><font color="#FF0000">{</font>imageProps<font color="#990000">.</font>currentMessage<font color="#990000">.</font>image<font color="#FF0000">}</font> alt<font color="#990000">=</font><font color="#FF0000">'Previwed Image'</font><font color="#990000">&gt;&lt;</font><font color="#FF6600">/img&gt;&lt;/</font>View<font color="#990000">&gt;</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">openPreview</font></b><font color="#990000">(</font>msgId<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'image_overlay'</font><font color="#990000">).</font>style<font color="#990000">.</font>display <font color="#990000">=</font> <font color="#FF0000">'block'</font><font color="#990000">;</font>
      <i><font color="#9A1900">// this.retrieveImagePreview(msgId).then((url) =&gt; {</font></i>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">retrieveData</font></b><font color="#990000">(</font>msgId<font color="#990000">).</font><b><font color="#000000">then</font></b><font color="#990000">((</font>data<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>data<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><font color="#FF0000">'error'</font><font color="#990000">))</font> <font color="#FF0000">{</font>
	  <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemMessage</font></b><font color="#990000">(</font><font color="#FF0000">'Could not open image: '</font> <font color="#990000">+</font> data<font color="#990000">[</font><font color="#FF0000">'error'</font><font color="#990000">]);</font>
	  document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'image_overlay'</font><font color="#990000">).</font>style<font color="#990000">.</font>display <font color="#990000">=</font> <font color="#FF0000">'none'</font><font color="#990000">;</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
	  let url <font color="#990000">=</font> data<font color="#990000">[</font><font color="#FF0000">'url'</font><font color="#990000">];</font>
          document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'preview_img'</font><font color="#990000">).</font>classList<font color="#990000">.</font><b><font color="#000000">remove</font></b><font color="#990000">(</font><font color="#FF0000">'center'</font><font color="#990000">);</font>
          document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'preview_img'</font><font color="#990000">).</font>innerHTML <font color="#990000">=</font> <font color="#FF0000">'&lt;img src=url style="position: absolute; display: block; left: 0; right :0; top: 0; bottom: 0; margin: auto; max-height:80%; max-width: 100%; z-index:2; object-fit: contain"&gt;&lt;/img&gt;'</font><font color="#990000">.</font><b><font color="#000000">replace</font></b><font color="#990000">(</font><font color="#FF0000">'url'</font><font color="#990000">,</font> url<font color="#990000">);</font>
	<font color="#FF0000">}</font>
      <font color="#FF0000">}</font><font color="#990000">)</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">'openPreview() exception: '</font> <font color="#990000">+</font> error<font color="#990000">.</font>message<font color="#990000">);</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemMessage</font></b><font color="#990000">(</font><font color="#FF0000">'Could not open image ('</font> <font color="#990000">+</font> error<font color="#990000">.</font>message <font color="#990000">+</font> <font color="#FF0000">')'</font><font color="#990000">);</font>
      document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'image_overlay'</font><font color="#990000">).</font>style<font color="#990000">.</font>display <font color="#990000">=</font> <font color="#FF0000">'none'</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">renderChatFooter</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>imgUrl <font color="#990000">?</font> <font color="#990000">&lt;</font>View style<font color="#990000">=</font><font color="#FF0000">{{</font> borderTopStyle<font color="#990000">:</font> <font color="#FF0000">'solid'</font><font color="#990000">,</font> borderTopColor<font color="#990000">:</font> <font color="#FF0000">'rgb(178, 178, 178)'</font><font color="#990000">,</font> borderTopWidth<font color="#990000">:</font> <font color="#FF0000">'1px'</font><font color="#990000">,</font> minHeight<font color="#990000">:</font> <font color="#FF0000">'50px'</font> <font color="#FF0000">}}</font><font color="#990000">&gt;&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">"close-btn"</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">()</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">removeInputFiles</font></b><font color="#990000">()</font> <font color="#FF0000">}}</font><font color="#990000">&gt;&amp;</font>#<font color="#993399">10006</font><font color="#990000">;&lt;</font><font color="#FF6600">/button&gt;&lt;img id='previewImage' width='150px' src={this.state.imgUrl} alt='Image preview'&gt;&lt;/img</font><font color="#990000">&gt;&lt;/</font>View<font color="#990000">&gt;</font> <font color="#990000">:</font> <b><font color="#0000FF">null</font></b>
  <font color="#FF0000">}</font>


  <b><font color="#000000">removeInputFiles</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'fileInput'</font><font color="#990000">))</font> <font color="#FF0000">{</font>
      document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'fileInput'</font><font color="#990000">).</font>value <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> imgUrl<font color="#990000">:</font> <b><font color="#0000FF">false</font></b> <font color="#FF0000">}</font><font color="#990000">)</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">chooseFile</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'fileInput'</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'fileInput'</font><font color="#990000">).</font><b><font color="#000000">click</font></b><font color="#990000">();</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">previewImage</font></b><font color="#990000">(</font>photo<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>photo<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">const</font></b> b64url <font color="#990000">=</font> await <b><font color="#0000FF">new</font></b> <b><font color="#000000">Promise</font></b><font color="#990000">((</font>resolve<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
          <b><font color="#0000FF">const</font></b> reader <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">FileReader</font></b><font color="#990000">();</font>
          reader<font color="#990000">.</font>onload <font color="#990000">=</font> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#990000">=&gt;</font> <b><font color="#000000">resolve</font></b><font color="#990000">(</font>e<font color="#990000">.</font>target<font color="#990000">.</font>result<font color="#990000">);</font>
          reader<font color="#990000">.</font><b><font color="#000000">readAsDataURL</font></b><font color="#990000">(</font>photo<font color="#990000">);</font>
        <font color="#FF0000">}</font><font color="#990000">);</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> imgUrl<font color="#990000">:</font> b64url <font color="#FF0000">}</font><font color="#990000">)</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">selectRoom</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> messages<font color="#990000">:</font> <font color="#990000">[]</font> <font color="#FF0000">}</font><font color="#990000">)</font>
      await <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">loadPersonalKeys</font></b><font color="#990000">();</font>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">join</font></b><font color="#990000">();</font>
      <i><font color="#9A1900">// const locked = await this.isRoomLocked();</font></i>
      <b><font color="#0000FF">const</font></b> username <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getUsername</font></b><font color="#990000">();</font>
      <i><font color="#9A1900">// this.setState({ locked: locked, username: username });</font></i>
      <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setState</font></b><font color="#990000">(</font><font color="#FF0000">{</font> username<font color="#990000">:</font> username <font color="#FF0000">}</font><font color="#990000">)</font>
      <b><font color="#0000FF">const</font></b> images <font color="#990000">=</font> document<font color="#990000">.</font><b><font color="#000000">querySelectorAll</font></b><font color="#990000">(</font><font color="#FF0000">'.msgImg'</font><font color="#990000">);</font>

      images<font color="#990000">.</font><b><font color="#000000">forEach</font></b><font color="#990000">(</font>el <font color="#990000">=&gt;</font> el<font color="#990000">.</font><b><font color="#000000">addEventListener</font></b><font color="#990000">(</font><font color="#FF0000">'touchforcechange'</font><font color="#990000">,</font> event <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
        event<font color="#990000">.</font><b><font color="#000000">preventDefault</font></b><font color="#990000">();</font>
      <font color="#FF0000">}</font><font color="#990000">));</font>
      let rooms <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>rooms<font color="#990000">;</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>rooms<font color="#990000">.</font><b><font color="#000000">hasOwnProperty</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">))</font> <font color="#FF0000">{</font>
        rooms<font color="#990000">[</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">]</font> <font color="#990000">=</font> <font color="#FF0000">{</font> name<font color="#990000">:</font> <font color="#FF0000">'Room '</font> <font color="#990000">+</font> <font color="#990000">(</font>Object<font color="#990000">.</font><b><font color="#000000">keys</font></b><font color="#990000">(</font>rooms<font color="#990000">).</font>length <font color="#990000">+</font> <font color="#993399">1</font><font color="#990000">).</font><b><font color="#000000">toString</font></b><font color="#990000">()</font> <font color="#FF0000">}</font><font color="#990000">;</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font><b><font color="#000000">updateRoomNames</font></b><font color="#990000">(</font>rooms<font color="#990000">)</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">renderTime</font></b><font color="#990000">(</font>props<font color="#990000">)</font> <font color="#FF0000">{</font>
    let return_str <font color="#990000">=</font> <font color="#FF0000">''</font><font color="#990000">;</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// Reference from https://stackoverflow.com/questions/32199998/check-if-date-is-today-was-yesterday-or-was-in-the-last-7-days</font></i>
      let months <font color="#990000">=</font> <font color="#990000">[</font><font color="#FF0000">"Jan"</font><font color="#990000">,</font> <font color="#FF0000">"Feb"</font><font color="#990000">,</font> <font color="#FF0000">"Mar"</font><font color="#990000">,</font> <font color="#FF0000">"Apr"</font><font color="#990000">,</font> <font color="#FF0000">"May"</font><font color="#990000">,</font> <font color="#FF0000">"Jun"</font><font color="#990000">,</font> <font color="#FF0000">"Jul"</font><font color="#990000">,</font> <font color="#FF0000">"Aug"</font><font color="#990000">,</font> <font color="#FF0000">"Sep"</font><font color="#990000">,</font> <font color="#FF0000">"Oct"</font><font color="#990000">,</font> <font color="#FF0000">"Nov"</font><font color="#990000">,</font> <font color="#FF0000">"Dec"</font><font color="#990000">];</font>
      let dt <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Date</font></b><font color="#990000">(</font>props<font color="#990000">.</font>currentMessage<font color="#990000">.</font>createdAt<font color="#990000">);</font>
      let date <font color="#990000">=</font> dt<font color="#990000">.</font><b><font color="#000000">getDate</font></b><font color="#990000">();</font>
      let month <font color="#990000">=</font> months<font color="#990000">[</font>dt<font color="#990000">.</font><b><font color="#000000">getMonth</font></b><font color="#990000">()];</font>
      let diffDays <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Date</font></b><font color="#990000">().</font><b><font color="#000000">getDate</font></b><font color="#990000">()</font> <font color="#990000">-</font> date<font color="#990000">;</font>
      let diffMonths <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Date</font></b><font color="#990000">().</font><b><font color="#000000">getMonth</font></b><font color="#990000">()</font> <font color="#990000">-</font> dt<font color="#990000">.</font><b><font color="#000000">getMonth</font></b><font color="#990000">();</font>
      let diffYears <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Date</font></b><font color="#990000">().</font><b><font color="#000000">getFullYear</font></b><font color="#990000">()</font> <font color="#990000">-</font> dt<font color="#990000">.</font><b><font color="#000000">getFullYear</font></b><font color="#990000">();</font>

      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>diffYears <font color="#990000">===</font> <font color="#993399">0</font> <font color="#990000">&amp;&amp;</font> diffDays <font color="#990000">===</font> <font color="#993399">0</font> <font color="#990000">&amp;&amp;</font> diffMonths <font color="#990000">===</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        return_str <font color="#990000">=</font> <font color="#FF0000">"Today"</font><font color="#990000">;</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>diffYears <font color="#990000">===</font> <font color="#993399">0</font> <font color="#990000">&amp;&amp;</font> diffDays <font color="#990000">===</font> <font color="#993399">1</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        return_str <font color="#990000">=</font> <font color="#FF0000">"Yesterday"</font><font color="#990000">;</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>diffYears <font color="#990000">&gt;=</font> <font color="#993399">1</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        return_str <font color="#990000">=</font> month <font color="#990000">+</font> <font color="#FF0000">" "</font> <font color="#990000">+</font> date <font color="#990000">+</font> <font color="#FF0000">", "</font> <font color="#990000">+</font> dt<font color="#990000">.</font><b><font color="#000000">getFullYear</font></b><font color="#990000">();</font>
      <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        return_str <font color="#990000">=</font> month <font color="#990000">+</font> <font color="#FF0000">" "</font> <font color="#990000">+</font> date<font color="#990000">;</font>
      <font color="#FF0000">}</font>
      return_str <font color="#990000">+=</font> <font color="#FF0000">", "</font> <font color="#990000">+</font> dt<font color="#990000">.</font><b><font color="#000000">toLocaleTimeString</font></b><font color="#990000">([],</font> <font color="#FF0000">{</font> hour12<font color="#990000">:</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> hour<font color="#990000">:</font> <font color="#FF0000">'numeric'</font><font color="#990000">,</font> minute<font color="#990000">:</font> <font color="#FF0000">'numeric'</font> <font color="#FF0000">}</font><font color="#990000">)</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
      return_str <font color="#990000">=</font> <font color="#FF0000">''</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <font color="#990000">(&lt;</font>View style<font color="#990000">=</font><font color="#FF0000">{{</font>
      marginLeft<font color="#990000">:</font> <font color="#993399">10</font><font color="#990000">,</font>
      marginRight<font color="#990000">:</font> <font color="#993399">10</font><font color="#990000">,</font>
    <font color="#FF0000">}}</font>
    <font color="#990000">&gt;</font>
      <font color="#990000">&lt;</font>Text
        style<font color="#990000">=</font><font color="#FF0000">{{</font>
          fontSize<font color="#990000">:</font> <font color="#993399">12</font><font color="#990000">,</font>
          backgroundColor<font color="#990000">:</font> <font color="#FF0000">'transparent'</font><font color="#990000">,</font>
          textAlign<font color="#990000">:</font> <font color="#FF0000">'right'</font><font color="#990000">,</font>
          color<font color="#990000">:</font> props<font color="#990000">.</font>currentMessage<font color="#990000">.</font>whispered <font color="#990000">||</font> props<font color="#990000">.</font>position <font color="#990000">===</font> <font color="#FF0000">'left'</font> <font color="#990000">?</font> <font color="#FF0000">'#aaa'</font> <font color="#990000">:</font> <font color="#FF0000">'white'</font>
        <font color="#FF0000">}}</font>
      <font color="#990000">&gt;</font><font color="#FF0000">{</font>return_str<font color="#FF0000">}</font>
      <font color="#990000">&lt;/</font>Text<font color="#990000">&gt;</font>
    <font color="#990000">&lt;/</font>View<font color="#990000">&gt;);</font>
  <font color="#FF0000">}</font>


  async <b><font color="#000000">componentDidMount</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>localStorage<font color="#990000">.</font><b><font color="#000000">getItem</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">)</font> <font color="#990000">===</font> <b><font color="#0000FF">null</font></b> <font color="#990000">&amp;&amp;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">!==</font> <font color="#FF0000">''</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        JwModal<font color="#990000">.</font><b><font color="#000000">open</font></b><font color="#990000">(</font><font color="#FF0000">'lastvisit-empty'</font><font color="#990000">);</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">'Error in componentDidMount()'</font><font color="#990000">)</font>
      console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">)</font>
    <font color="#FF0000">}</font>

    <b><font color="#0000FF">if</font></b> <font color="#990000">(!(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>error<font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> localStorage<font color="#990000">.</font><b><font color="#000000">getItem</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">)</font> <font color="#990000">!==</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">selectRoom</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">);</font>
        <i><font color="#9A1900">// this.addEventListeners();      TODO</font></i>
      <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
        console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendSystemInfo</font></b><font color="#990000">(</font><font color="#FF0000">'Could not enter the room'</font><font color="#990000">)</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>


  <b><font color="#000000">render</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey <font color="#990000">||</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>error <font color="#990000">||</font> localStorage<font color="#990000">.</font><b><font color="#000000">getItem</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">)</font> <font color="#990000">===</font> <b><font color="#0000FF">null</font></b> <font color="#990000">?</font> <font color="#990000">(</font>
      <font color="#990000">&lt;</font>View style<font color="#990000">=</font><font color="#FF0000">{{</font> width<font color="#990000">:</font> <font color="#FF0000">"100%"</font><font color="#990000">,</font> height<font color="#990000">:</font> <font color="#FF0000">"100%"</font><font color="#990000">,</font> flex<font color="#990000">:</font> <font color="#993399">1</font><font color="#990000">,</font> display<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>className <font color="#990000">===</font> <font color="#FF0000">'hidden'</font> <font color="#990000">&amp;&amp;</font> window<font color="#990000">.</font>location<font color="#990000">.</font>pathname <font color="#990000">!==</font> <font color="#FF0000">'/'</font> <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">'/admin'</font> <font color="#990000">?</font> <font color="#FF0000">'none'</font> <font color="#990000">:</font> <b><font color="#0000FF">null</font></b> <font color="#FF0000">}}</font><font color="#990000">&gt;</font>
        <font color="#990000">&lt;</font>View style<font color="#990000">=</font><font color="#FF0000">{{</font> width<font color="#990000">:</font> <font color="#FF0000">"100%"</font><font color="#990000">,</font> height<font color="#990000">:</font> <font color="#FF0000">"100%"</font><font color="#990000">,</font> flex<font color="#990000">:</font> <font color="#993399">1</font><font color="#990000">,</font> display<font color="#990000">:</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>className <font color="#990000">===</font> <font color="#FF0000">'hidden'</font> <font color="#990000">?</font> <font color="#FF0000">'none'</font> <font color="#990000">:</font> <b><font color="#0000FF">null</font></b> <font color="#FF0000">}}</font><font color="#990000">&gt;</font>
          <font color="#990000">&lt;</font>JwModal id<font color="#990000">=</font><font color="#FF0000">"room-response"</font><font color="#990000">&gt;</font>
            <font color="#990000">&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">'admin-button gray-btn'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font>JwModal<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#FF0000">'admin-response'</font><font color="#990000">)</font><font color="#FF0000">}</font><font color="#990000">&gt;</font>Close<font color="#990000">&lt;/</font>button<font color="#990000">&gt;</font>
          <font color="#990000">&lt;/</font>JwModal<font color="#990000">&gt;</font>
          <font color="#990000">&lt;</font>JwModal id<font color="#990000">=</font><font color="#FF0000">"change-username"</font><font color="#990000">&gt;</font>
            <font color="#990000">&lt;</font>label htmlFor<font color="#990000">=</font><font color="#FF0000">"username-input"</font> style<font color="#990000">=</font><font color="#FF0000">{{</font> fontSize<font color="#990000">:</font> <font color="#FF0000">"16px"</font> <font color="#FF0000">}}</font><font color="#990000">&gt;&lt;</font>Trans id<font color="#990000">=</font><font color="#FF0000">'change username label'</font><font color="#990000">&gt;</font>Change Username<font color="#990000">&lt;</font><font color="#FF6600">/Trans&gt;&lt;/</font>label<font color="#990000">&gt;</font>
            <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
            <font color="#990000">&lt;</font>input type<font color="#990000">=</font><font color="#FF0000">"text"</font> id<font color="#990000">=</font><font color="#FF0000">'username-input'</font> placeholder<font color="#990000">=</font><font color="#FF0000">"Enter Username Here"</font> defaultValue<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>changeUsername<font color="#990000">.</font>name<font color="#FF0000">}</font> onFocus<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>event<font color="#990000">)</font> <font color="#990000">=&gt;</font> event<font color="#990000">.</font>target<font color="#990000">.</font><b><font color="#000000">select</font></b><font color="#990000">()</font><font color="#FF0000">}</font> autoFocus <font color="#990000">/&gt;</font>
            <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
            <font color="#990000">&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">'admin-button green-btn'</font> id<font color="#990000">=</font><font color="#FF0000">'change-username-save-btn'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">()</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">saveUsername</font></b><font color="#990000">()</font> <font color="#FF0000">}}</font><font color="#990000">&gt;&lt;</font>Trans id<font color="#990000">=</font><font color="#FF0000">'save button text'</font><font color="#990000">&gt;</font>Save<font color="#990000">&lt;</font><font color="#FF6600">/Trans&gt;&lt;/</font>button<font color="#990000">&gt;</font>
            <font color="#990000">&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">'admin-button gray-btn'</font> id<font color="#990000">=</font><font color="#FF0000">'change-username-close-btn'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font>JwModal<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#FF0000">'change-username'</font><font color="#990000">)</font><font color="#FF0000">}</font><font color="#990000">&gt;&lt;</font>Trans id<font color="#990000">=</font><font color="#FF0000">'cancel button text'</font><font color="#990000">&gt;</font>Cancel<font color="#990000">&lt;</font><font color="#FF6600">/Trans&gt;&lt;/</font>button<font color="#990000">&gt;</font>
            <font color="#990000">&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">'admin-button green-btn'</font> id<font color="#990000">=</font><font color="#FF0000">'change-username-me-btn'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">()</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
              document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'username-input'</font><font color="#990000">).</font>value <font color="#990000">=</font> <font color="#FF0000">'Me'</font><font color="#990000">;</font>
              <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">saveUsername</font></b><font color="#990000">();</font>
	     <font color="#FF0000">}}</font><font color="#990000">&gt;&lt;</font>Trans id<font color="#990000">=</font><font color="#FF0000">'change username me button text'</font><font color="#990000">&gt;</font>Me<font color="#990000">&lt;</font><font color="#FF6600">/Trans&gt;&lt;/</font>button<font color="#990000">&gt;</font>
          <font color="#990000">&lt;/</font>JwModal<font color="#990000">&gt;</font>
          <font color="#990000">&lt;</font>JwModal id<font color="#990000">=</font><font color="#FF0000">'whisper-user'</font><font color="#990000">&gt;</font>
            <font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>reply_to <font color="#990000">?</font>
              <font color="#990000">&lt;</font>div<font color="#990000">&gt;</font>
                <font color="#990000">&lt;</font>Trans id<font color="#990000">=</font><font color="#FF0000">'whisper header'</font><font color="#990000">&gt;</font>Whisper to <font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>contacts<font color="#990000">[</font>JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>reply_to<font color="#990000">.</font>_id<font color="#990000">).</font>x <font color="#990000">+</font> <font color="#FF0000">' '</font> <font color="#990000">+</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>reply_to<font color="#990000">.</font>_id<font color="#990000">).</font>y<font color="#990000">]</font><font color="#FF0000">}</font><font color="#990000">&lt;/</font>Trans<font color="#990000">&gt;</font>
                <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
                <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
                <font color="#990000">&lt;</font>textarea rows<font color="#990000">=</font><font color="#FF0000">{</font><font color="#993399">5</font><font color="#FF0000">}</font> cols<font color="#990000">=</font><font color="#FF0000">{</font><font color="#993399">50</font><font color="#FF0000">}</font> id<font color="#990000">=</font><font color="#FF0000">'whisper-text'</font><font color="#990000">&gt;&lt;/</font>textarea<font color="#990000">&gt;</font>
                <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
                <font color="#990000">&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">'admin-button green-btn'</font> id<font color="#990000">=</font><font color="#FF0000">'send-whisper-btn'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>e<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
                  <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendMessage</font></b><font color="#990000">([</font><font color="#FF0000">{</font> text<font color="#990000">:</font> document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'whisper-text'</font><font color="#990000">).</font>value <font color="#FF0000">}</font><font color="#990000">]);</font>
                  JwModal<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#FF0000">'whisper-user'</font><font color="#990000">)(</font>e<font color="#990000">);</font>
                <font color="#FF0000">}}</font><font color="#990000">&gt;&lt;</font>Trans id<font color="#990000">=</font><font color="#FF0000">'send button text'</font><font color="#990000">&gt;</font>Send<font color="#990000">&lt;</font><font color="#FF6600">/Trans&gt;&lt;/</font>button<font color="#990000">&gt;</font>
                <font color="#990000">&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">'admin-button gray-btn'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>e<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
                  JwModal<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#FF0000">'whisper-user'</font><font color="#990000">)(</font>e<font color="#990000">);</font>
                  <b><font color="#0000FF">delete</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>reply_to<font color="#990000">;</font>
                  <b><font color="#0000FF">delete</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>reply_encryptionKey<font color="#990000">;</font>
                <font color="#FF0000">}</font>
                <font color="#FF0000">}</font><font color="#990000">&gt;&lt;</font>Trans id<font color="#990000">=</font><font color="#FF0000">'cancel button text'</font><font color="#990000">&gt;</font>Cancel<font color="#990000">&lt;</font><font color="#FF6600">/Trans&gt;&lt;/</font>button<font color="#990000">&gt;</font>
                <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
              <font color="#990000">&lt;/</font>div<font color="#990000">&gt;</font> <font color="#990000">:</font> <b><font color="#0000FF">null</font></b><font color="#FF0000">}</font>
          <font color="#990000">&lt;/</font>JwModal<font color="#990000">&gt;</font>
          <font color="#990000">&lt;</font>JwModal id<font color="#990000">=</font><font color="#FF0000">{</font><font color="#FF0000">'user-info-'</font> <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#FF0000">}</font><font color="#990000">&gt;</font>
            <font color="#990000">&lt;</font>h2<font color="#990000">&gt;</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>roomName<font color="#FF0000">}</font><font color="#990000">&lt;/</font>h2<font color="#990000">&gt;</font>
            <font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>motd <font color="#990000">!==</font> <font color="#FF0000">''</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">&lt;</font>Trans id<font color="#990000">=</font><font color="#FF0000">'motd text'</font><font color="#990000">&gt;</font>Message of the day<font color="#990000">:</font> <font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>motd<font color="#FF0000">}</font><font color="#990000">&lt;/</font>Trans<font color="#990000">&gt;</font><font color="#FF0000">}</font>
            <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
            <font color="#FF0000">{</font><font color="#990000">!</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>room_owner <font color="#990000">?</font>
              <font color="#990000">&lt;</font>div<font color="#990000">&gt;</font>
                Whisper to room owner<font color="#990000">.</font>
                <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
                <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
                <font color="#990000">&lt;</font>textarea rows<font color="#990000">=</font><font color="#FF0000">{</font><font color="#993399">5</font><font color="#FF0000">}</font> cols<font color="#990000">=</font><font color="#FF0000">{</font><font color="#993399">50</font><font color="#FF0000">}</font> id<font color="#990000">=</font><font color="#FF0000">'whisper-text'</font> placeholder<font color="#990000">=</font><font color="#FF0000">'Whisper to owner'</font><font color="#990000">&gt;&lt;/</font>textarea<font color="#990000">&gt;</font>
                <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
              <font color="#990000">&lt;/</font>div<font color="#990000">&gt;</font> <font color="#990000">:</font> <b><font color="#0000FF">null</font></b><font color="#FF0000">}</font>
            <font color="#FF0000">{</font><font color="#990000">!</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>room_owner <font color="#990000">?</font> <font color="#990000">&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">'admin-button green-btn'</font> id<font color="#990000">=</font><font color="#FF0000">'send-whisper-btn'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>e<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
              <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendMessage</font></b><font color="#990000">([</font><font color="#FF0000">{</font> text<font color="#990000">:</font> document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'whisper-text'</font><font color="#990000">).</font>value <font color="#FF0000">}</font><font color="#990000">],</font> <b><font color="#0000FF">true</font></b><font color="#990000">);</font>
              JwModal<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#FF0000">'user-info-'</font> <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">)(</font>e<font color="#990000">)</font>
            <font color="#FF0000">}}</font><font color="#990000">&gt;</font>Send<font color="#990000">&lt;/</font>button<font color="#990000">&gt;</font> <font color="#990000">:</font> <b><font color="#0000FF">null</font></b><font color="#FF0000">}</font>
            <font color="#990000">&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">'admin-button gray-btn'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font>JwModal<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#FF0000">'user-info-'</font> <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">)</font><font color="#FF0000">}</font><font color="#990000">&gt;</font>Close<font color="#990000">&lt;/</font>button<font color="#990000">&gt;</font>
          <font color="#990000">&lt;/</font>JwModal<font color="#990000">&gt;</font>
          <font color="#990000">&lt;</font>JwModal id<font color="#990000">=</font><font color="#FF0000">'lock-info-modal'</font><font color="#990000">&gt;</font>
            <font color="#990000">&lt;</font>h2<font color="#990000">&gt;</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>roomName<font color="#FF0000">}</font><font color="#990000">&lt;/</font>h2<font color="#990000">&gt;</font>
            <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
            <font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>locked <font color="#990000">&amp;&amp;</font> <font color="#FF0000">"The green 'lock' icon indicates this room is restricted by the Owner. Only accepted participants can send and receive chats. Remember to make sure you dont lose your locally stored keys, because if you do, the Owner will have to accept you again."</font><font color="#FF0000">}</font>
            <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
            <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
            <font color="#990000">&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">'admin-button gray-btn'</font> id<font color="#990000">=</font><font color="#FF0000">'lock-info-close-btn'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font>JwModal<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#FF0000">'lock-info-modal'</font><font color="#990000">)</font><font color="#FF0000">}</font><font color="#990000">&gt;</font>Close<font color="#990000">&lt;/</font>button<font color="#990000">&gt;</font>
          <font color="#990000">&lt;/</font>JwModal<font color="#990000">&gt;</font>
          <font color="#990000">&lt;</font>JwModal id<font color="#990000">=</font><font color="#FF0000">'lastvisit-empty'</font><font color="#990000">&gt;</font>
            <font color="#990000">&lt;</font>Trans id<font color="#990000">=</font><font color="#FF0000">'first visit modal message'</font><font color="#990000">&gt;</font>Welcome<font color="#990000">!</font> If <b><font color="#0000FF">this</font></b> is the first time youve been to <b><font color="#0000FF">this</font></b> room<font color="#990000">,</font> enter your username <b><font color="#0000FF">for</font></b> <b><font color="#0000FF">this</font></b> room and press Ok and we we will generate fresh cryptographic keys that are unique to you and to <b><font color="#0000FF">this</font></b> room<font color="#990000">.</font> If you have already been here<font color="#990000">,</font> then you might want to load your keys from your backup <font color="#990000">-</font> press Cancel and well take you to the Home tab<font color="#990000">.&lt;/</font>Trans<font color="#990000">&gt;</font>
            <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
            <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
            <font color="#990000">&lt;</font>input type<font color="#990000">=</font><font color="#FF0000">"text"</font> id<font color="#990000">=</font><font color="#FF0000">'public-username-input'</font> placeholder<font color="#990000">=</font><font color="#FF0000">"Enter Username Here"</font> onFocus<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>event<font color="#990000">)</font> <font color="#990000">=&gt;</font> event<font color="#990000">.</font>target<font color="#990000">.</font><b><font color="#000000">select</font></b><font color="#990000">()</font><font color="#FF0000">}</font> autoFocus <font color="#990000">/&gt;</font>
            <font color="#990000">&lt;</font>br <font color="#990000">/&gt;</font>
            <font color="#990000">&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">'admin-button green-btn'</font> id<font color="#990000">=</font><font color="#FF0000">'acknowledge-localstorage-btn'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>e<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
              localStorage<font color="#990000">.</font><b><font color="#000000">setItem</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">'_username'</font><font color="#990000">,</font> document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'public-username-input'</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> document<font color="#990000">.</font><b><font color="#000000">getElementById</font></b><font color="#990000">(</font><font color="#FF0000">'public-username-input'</font><font color="#990000">).</font>value<font color="#990000">)</font>
              JwModal<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">(</font><font color="#FF0000">'lastvisit-empty'</font><font color="#990000">)(</font>e<font color="#990000">);</font>
              <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">selectRoom</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>roomId<font color="#990000">);</font>
            <font color="#FF0000">}}</font><font color="#990000">&gt;&lt;</font>Trans id<font color="#990000">=</font><font color="#FF0000">'ok button text'</font><font color="#990000">&gt;</font>Ok<font color="#990000">&lt;</font><font color="#FF6600">/Trans&gt;&lt;/</font>button<font color="#990000">&gt;</font>
            <font color="#990000">&lt;</font>button className<font color="#990000">=</font><font color="#FF0000">'admin-button green-btn'</font> id<font color="#990000">=</font><font color="#FF0000">'cancel-localstorage-btn'</font> onClick<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>e<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font>
              window<font color="#990000">.</font>location<font color="#990000">.</font>href <font color="#990000">=</font> <font color="#FF0000">'{ process.env.PUBLIC_URL }'</font>
            <font color="#FF0000">}}</font><font color="#990000">&gt;&lt;</font>Trans id<font color="#990000">=</font><font color="#FF0000">'cancel button text'</font><font color="#990000">&gt;</font>Cancel<font color="#990000">&lt;</font><font color="#FF6600">/Trans&gt;&lt;/</font>button<font color="#990000">&gt;</font>
          <font color="#990000">&lt;/</font>JwModal<font color="#990000">&gt;</font>
          <font color="#990000">&lt;</font>GiftedChat
            messages<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>messages<font color="#FF0000">}</font>
            onSend<font color="#990000">=</font><font color="#FF0000">{</font>messages <font color="#990000">=&gt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">sendMessage</font></b><font color="#990000">(</font>messages<font color="#990000">)</font><font color="#FF0000">}</font>
            <i><font color="#9A1900">// timeFormat='L LT'</font></i>
            user<font color="#990000">=</font><font color="#FF0000">{{</font> _id<font color="#990000">:</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#990000">)</font> <font color="#FF0000">}}</font>
            inverted<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">false</font></b><font color="#FF0000">}</font>
            alwaysShowSend<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">true</font></b><font color="#FF0000">}</font>
            loadEarlier<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>moreMessages<font color="#FF0000">}</font>
            isLoadingEarlier<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>loadingMore<font color="#FF0000">}</font>
            onLoadEarlier<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">()</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font> <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">getOldMessages</font></b><font color="#990000">()</font> <font color="#FF0000">}}</font>
            renderActions<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">()</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font> <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">renderAttachmentIcon</font></b><font color="#990000">()</font> <font color="#FF0000">}}</font>
            <i><font color="#9A1900">// renderUsernameOnMessage={true}</font></i>
            <i><font color="#9A1900">// infiniteScroll={true}   // This is not supported for web yet</font></i>
            renderMessageImage<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>props<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font> <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">renderImage</font></b><font color="#990000">(</font>props<font color="#990000">)</font> <font color="#FF0000">}}</font>
            scrollToBottom<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">true</font></b><font color="#FF0000">}</font>
            showUserAvatar<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">true</font></b><font color="#FF0000">}</font>
            onPressAvatar<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>context<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font> <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">promptUsername</font></b><font color="#990000">(</font>context<font color="#990000">)</font> <font color="#FF0000">}}</font>
            onLongPressAvatar<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>context<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font> <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">handleReply</font></b><font color="#990000">(</font>context<font color="#990000">)</font> <font color="#FF0000">}}</font>
            renderChatFooter<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">()</font> <font color="#990000">=&gt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">renderChatFooter</font></b><font color="#990000">()</font><font color="#FF0000">}</font>
            renderBubble<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>props<font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#FF0000">{</font> <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">renderBubble</font></b><font color="#990000">(</font>props<font color="#990000">)</font> <font color="#FF0000">}}</font>
            <i><font color="#9A1900">// onPress={(context, message) =&gt; { return this.handleReply(message.user) }}</font></i>
            <i><font color="#9A1900">// textInputProps={this.getInputPlaceHolder()}</font></i>
            onLongPress<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">()</font> <font color="#990000">=&gt;</font> <b><font color="#0000FF">false</font></b><font color="#FF0000">}</font>
            renderTime<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>props<font color="#990000">)</font> <font color="#990000">=&gt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">renderTime</font></b><font color="#990000">(</font>props<font color="#990000">)</font><font color="#FF0000">}</font>
          <font color="#990000">/&gt;</font>
        <font color="#990000">&lt;/</font>View <font color="#990000">&gt;</font>
        <font color="#FF0000">{</font> <font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>room_admin <font color="#990000">||</font> process<font color="#990000">.</font>env<font color="#990000">.</font>REACT_APP_ROOM_SERVER <font color="#990000">!==</font> <font color="#FF0000">'s4.privacy.app'</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">&lt;</font>Route exact path<font color="#990000">=</font><font color="#FF0000">{</font><font color="#FF0000">"/"</font> <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>roomId <font color="#990000">+</font> <font color="#FF0000">"/admin"</font><font color="#FF0000">}</font> children<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font><font color="#FF0000">{</font> match <font color="#FF0000">}</font><font color="#990000">)</font> <font color="#990000">=&gt;</font> <font color="#990000">(</font>
          <font color="#990000">&lt;</font>Admin
            id<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>locked <font color="#990000">+</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>motd<font color="#FF0000">}</font>
            roomName<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>roomName<font color="#FF0000">}</font>
            className<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">!</font>match <font color="#990000">?</font> <font color="#FF0000">'hidden'</font> <font color="#990000">:</font> <b><font color="#0000FF">null</font></b><font color="#FF0000">}</font>
            updateAdmin<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>getAdminData<font color="#FF0000">}</font>
            updateContacts<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>contacts<font color="#990000">)</font> <font color="#990000">=&gt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font><b><font color="#000000">updateContacts</font></b><font color="#990000">(</font>contacts<font color="#990000">)</font><font color="#FF0000">}</font>
            adminError<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>adminError<font color="#FF0000">}</font>
            roomCapacity<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>roomCapacity<font color="#FF0000">}</font>
            locked<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>locked<font color="#FF0000">}</font>
            joinRequests<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>joinRequests<font color="#FF0000">}</font>
            contacts<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>props<font color="#990000">.</font>contacts<font color="#FF0000">}</font>
            exportable_pubKey<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>keys<font color="#990000">.</font>exportable_pubKey<font color="#FF0000">}</font>
            motd<font color="#990000">=</font><font color="#FF0000">{</font><b><font color="#0000FF">this</font></b><font color="#990000">.</font>state<font color="#990000">.</font>motd<font color="#FF0000">}</font>
            updateRoomCapacity<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>roomCapacity<font color="#990000">)</font> <font color="#990000">=&gt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">updateRoomCapacity</font></b><font color="#990000">(</font>roomCapacity<font color="#990000">)</font><font color="#FF0000">}</font>
            acceptVisitor<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">(</font>pubKey<font color="#990000">)</font> <font color="#990000">=&gt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">acceptVisitor</font></b><font color="#990000">(</font>pubKey<font color="#990000">)</font><font color="#FF0000">}</font>
            lockRoom<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">()</font> <font color="#990000">=&gt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">lockRoom</font></b><font color="#990000">()</font><font color="#FF0000">}</font>
            setMOTD<font color="#990000">=</font><font color="#FF0000">{</font><font color="#990000">()</font> <font color="#990000">=&gt;</font> <b><font color="#0000FF">this</font></b><font color="#990000">.</font><b><font color="#000000">setMOTD</font></b><font color="#990000">()</font><font color="#FF0000">}</font> <font color="#990000">/&gt;</font>
        <font color="#990000">)</font><font color="#FF0000">}</font>
        <font color="#990000">/&gt;</font><font color="#FF0000">}</font>
      <font color="#990000">&lt;</font><font color="#FF6600">/View&gt;) : &lt;div&gt;&lt;Trans id='loading room text'&gt;Loading room...{this.roomId}&lt;/</font>Trans<font color="#990000">&gt;&lt;/</font>div<font color="#990000">&gt;)</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

<b><font color="#0000FF">export</font></b> <b><font color="#0000FF">default</font></b> Room<font color="#990000">;</font>
</tt></pre>
